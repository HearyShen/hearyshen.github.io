<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="WmzZoAIhtw8L5PpX">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"heary.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="mmdetection是一款优秀的基于PyTorch的开源目标检测系统，由香港中文大学多媒体实验室开发，遵循Apache-2.0开源协议。由于该框架只有README文件说明，而没有文档，源代码注释也寥寥，因此为了理解该框架，我读了几天源代码，以下做一点整理记录。">
<meta property="og:type" content="article">
<meta property="og:title" content="mmdetection - 基于PyTorch的开源目标检测系统">
<meta property="og:url" content="https://heary.cn/posts/mmdetection-%E5%9F%BA%E4%BA%8EPyTorch%E7%9A%84%E5%BC%80%E6%BA%90%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Heary&#39;s Blog">
<meta property="og:description" content="mmdetection是一款优秀的基于PyTorch的开源目标检测系统，由香港中文大学多媒体实验室开发，遵循Apache-2.0开源协议。由于该框架只有README文件说明，而没有文档，源代码注释也寥寥，因此为了理解该框架，我读了几天源代码，以下做一点整理记录。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-03-16T09:02:19.000Z">
<meta property="article:modified_time" content="2022-08-07T04:02:09.866Z">
<meta property="article:author" content="Heary">
<meta property="article:tag" content="Object Detection">
<meta property="article:tag" content="CV">
<meta property="article:tag" content="PyTorch">
<meta property="article:tag" content="mmdetection">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://heary.cn/posts/mmdetection-%E5%9F%BA%E4%BA%8EPyTorch%E7%9A%84%E5%BC%80%E6%BA%90%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://heary.cn/posts/mmdetection-%E5%9F%BA%E4%BA%8EPyTorch%E7%9A%84%E5%BC%80%E6%BA%90%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/","path":"posts/mmdetection-基于PyTorch的开源目标检测系统/","title":"mmdetection - 基于PyTorch的开源目标检测系统"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>mmdetection - 基于PyTorch的开源目标检测系统 | Heary's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135282529-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-135282529-1","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?93bca42dda78417b488ac006a6ac5444"></script>


  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{&quot;token&quot;: &quot;e56a1ace8bf142f3b73bedc96953a959&quot;}'></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Heary's Blog" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Heary's Blog" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Heary's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">渡口缀满灯花</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">186</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">146</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#mmdetection---%E5%9F%BA%E4%BA%8Epytorch%E7%9A%84%E5%BC%80%E6%BA%90%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F"><span class="nav-text">mmdetection -
基于PyTorch的开源目标检测系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B"><span class="nav-text">0 开始</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#toolstrain.py%E8%AE%AD%E7%BB%83%E8%A7%A3%E6%9E%90"><span class="nav-text">1
tools&#x2F;train.py训练解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="nav-text">1.1 使用说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#toolstrain.py%E8%AE%AD%E7%BB%83"><span class="nav-text">1.1.1 tools&#x2F;train.py训练</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#toolsdist_train.sh%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83"><span class="nav-text">1.1.2
tools&#x2F;dist_train.sh分布式训练</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83"><span class="nav-text">1.2 源代码参考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="nav-text">1.3 原理解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%8E%9F%E7%90%86"><span class="nav-text">1.3.1 主要原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mmdet.api.train%E8%A7%A3%E6%9E%90"><span class="nav-text">1.3.2 mmdet.api.train解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#toolstest.py%E6%B5%8B%E8%AF%95%E8%A7%A3%E6%9E%90"><span class="nav-text">2 tools&#x2F;test.py测试解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E-1"><span class="nav-text">2.1 使用说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0%E6%96%87%E4%BB%B6"><span class="nav-text">2.1.1 输出到文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%84%E4%BC%B0bbox%E7%AD%89%E9%A2%84%E6%B5%8B%E6%8C%87%E6%A0%87"><span class="nav-text">2.1.2 评估bbox等预测指标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E9%A2%84%E6%B5%8B%E7%BB%93%E6%9E%9C"><span class="nav-text">2.1.3 可视化预测结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83-1"><span class="nav-text">2.2 源代码参考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-1"><span class="nav-text">2.3 原理解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%8E%9F%E7%90%86-1"><span class="nav-text">2.3.1 主要原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#single_test%E5%8D%95%E8%AE%BE%E5%A4%87%E6%B5%8B%E8%AF%95"><span class="nav-text">2.3.2
single_test单设备测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#models%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0%E8%A7%A3%E6%9E%90"><span class="nav-text">3 models模型实现解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#single_stage.py%E8%A7%A3%E6%9E%90"><span class="nav-text">3.1 single_stage.py解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83-2"><span class="nav-text">3.1.1 源代码参考</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-2"><span class="nav-text">3.1.2 原理解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#two_stage.py%E8%A7%A3%E6%9E%90"><span class="nav-text">3.2 two_stage.py解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83-3"><span class="nav-text">3.2.1 源代码参考</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-3"><span class="nav-text">3.2.2 原理解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E9%9B%86%E8%A7%A3%E6%9E%90"><span class="nav-text">4 自定义数据集解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#coco.py%E8%A7%A3%E6%9E%90"><span class="nav-text">4.1 coco.py解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83-4"><span class="nav-text">4.1.1 源代码参考</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-4"><span class="nav-text">4.1.2 原理解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bbox%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90"><span class="nav-text">5 bbox数据结构解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#coco%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84bbox%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">5.1 COCO数据集的bbox数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mmdetection%E4%B8%AD%E7%9A%84bbox%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">5.2
mmdetection中的bbox数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cocodataset%E5%AF%B9bbox%E7%9A%84%E8%A7%A3%E6%9E%90%E8%BD%AC%E6%8D%A2"><span class="nav-text">5.2.1
CocoDataset对bbox的解析转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bbox2result%E8%A7%A3%E6%9E%90"><span class="nav-text">5.2.2 bbox2result解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83-5"><span class="nav-text">5.2.2.1 源代码参考</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-5"><span class="nav-text">5.2.2.2 原理解析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#anchorhead.get_boxes%E8%A7%A3%E6%9E%90"><span class="nav-text">5.2.3
AnchorHead.get_boxes解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#get_boxes%E8%A7%A3%E6%9E%90"><span class="nav-text">5.2.3.1 get_boxes解析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#get_boxes_single%E8%A7%A3%E6%9E%90"><span class="nav-text">5.2.3.2
get_boxes_single解析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#multiclass_nms%E8%A7%A3%E6%9E%90"><span class="nav-text">5.2.4 multiclass_nms解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83-6"><span class="nav-text">5.2.4.1 源代码参考</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-6"><span class="nav-text">5.2.4.2 原理解析</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Heary"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Heary</p>
  <div class="site-description" itemprop="description">养天地正气 法古今完人</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">186</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/HearyShen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;HearyShen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/jiayun-shen/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;jiayun-shen&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jiayun.shen@foxmail.com" title="E-Mail → mailto:jiayun.shen@foxmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://heary.cn/" title="https:&#x2F;&#x2F;heary.cn">Heary's Blog(Main)</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://hearyshen.github.io/" title="https:&#x2F;&#x2F;hearyshen.github.io" rel="noopener" target="_blank">Heary's Blog(Mirror)</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://lonelyone.cn/" title="http:&#x2F;&#x2F;lonelyone.cn" rel="noopener" target="_blank">Lonelyone.cn</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://piaoyu.org/" title="http:&#x2F;&#x2F;piaoyu.org" rel="noopener" target="_blank">piaoyu.org</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://transformerswsz.github.io/" title="https:&#x2F;&#x2F;transformerswsz.github.io" rel="noopener" target="_blank">Swift的博客</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://log4me.github.io/" title="https:&#x2F;&#x2F;log4me.github.io&#x2F;" rel="noopener" target="_blank">logme's blog</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://lossherl.github.io/" title="https:&#x2F;&#x2F;lossherl.github.io&#x2F;" rel="noopener" target="_blank">Sherl's</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://heary.cn/posts/mmdetection-%E5%9F%BA%E4%BA%8EPyTorch%E7%9A%84%E5%BC%80%E6%BA%90%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Heary">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heary's Blog">
      <meta itemprop="description" content="养天地正气 法古今完人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="mmdetection - 基于PyTorch的开源目标检测系统 | Heary's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mmdetection - 基于PyTorch的开源目标检测系统
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-16 17:02:19" itemprop="dateCreated datePublished" datetime="2019-03-16T17:02:19+08:00">2019-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-08-07 12:02:09" itemprop="dateModified" datetime="2022-08-07T12:02:09+08:00">2022-08-07</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>30 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection">mmdetection</a>是一款优秀的基于PyTorch的开源目标检测系统，由<a
target="_blank" rel="noopener" href="http://mmlab.ie.cuhk.edu.hk/">香港中文大学多媒体实验室</a>开发，遵循Apache-2.0开源协议。由于该框架只有README文件说明，而没有文档，源代码注释也寥寥，因此为了理解该框架，我读了几天源代码，以下做一点整理记录。</p>
<span id="more"></span>
<h1 id="mmdetection---基于pytorch的开源目标检测系统">mmdetection -
基于PyTorch的开源目标检测系统</h1>
<h2 id="开始">0 开始</h2>
<blockquote>
<p><a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection">open-mmlab/mmdetection</a></p>
</blockquote>
<ul>
<li>mmdetection的GitHub主页</li>
</ul>
<blockquote>
<p><a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection/blob/master/INSTALL.md">mmdetection/INSTALL.md</a></p>
</blockquote>
<ul>
<li>mmdetection的安装说明</li>
<li>mmdetection只支持Linux环境。经测试，在Windows10系统下即使解决了sh脚本执行问题，也会在编译环节遭遇错误。</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmcv">open-mmlab/mmcv</a></p>
</blockquote>
<ul>
<li>mmcv是mmdetection依赖的重要计算机视觉库</li>
</ul>
<h2 id="toolstrain.py训练解析">1
<code>tools/train.py</code>训练解析</h2>
<h3 id="使用说明">1.1 使用说明</h3>
<h4 id="toolstrain.py训练">1.1.1 <code>tools/train.py</code>训练</h4>
<p>在GPU 3上训练一个backbone为ResNet-50的Cascade R-CNN模型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUDA_VISIBLE_DEVICES=3 python tools/train.py configs/xray_cascade_rcnn_r50_fpn_1x.py</span><br></pre></td></tr></table></figure>
<p>其它常用选项：</p>
<ul>
<li><code>--work_dir</code>是模型checkpoint文件的输出目录，可以在<code>configs/*.py</code>中配置；</li>
<li><code>--resume_from</code>是指定在某个checkpoint的基础上继续训练，可以在<code>configs/*.py</code>中配置；</li>
<li><code>--validate</code>是指是否在训练中建立checkpoint的时候对该checkpoint进行评估（evaluate）；</li>
<li><code>--gpus</code>是指使用的GPU<strong>数量</strong>，默认值为1颗；</li>
<li><code>--launcher</code>是指分布式训练的任务启动器（job
launcher），默认值为<code>none</code>表示不进行分布式训练；</li>
</ul>
<h4 id="toolsdist_train.sh分布式训练">1.1.2
<code>tools/dist_train.sh</code>分布式训练</h4>
<p>也可以使用分布式训练，在单台或多台机器上进行分布式训练：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tools/dist_train.sh &lt;CONFIG_FILE&gt; &lt;GPU_NUM&gt; [optional arguments]</span><br></pre></td></tr></table></figure>
<p>实质上<code>/tools/dist_train.sh</code>很简单，就是调用<code>tools/train.py</code>并配置<code>--launcher</code>选项为<code>pytorch</code>以便启动分布式训练。<code>/tools/dist_train.sh</code>脚本实现如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">PYTHON=<span class="variable">$&#123;PYTHON:-&quot;python&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$PYTHON</span> -m torch.distributed.launch --nproc_per_node=<span class="variable">$2</span> $(<span class="built_in">dirname</span> <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)/train.py <span class="variable">$1</span> --launcher pytorch <span class="variable">$&#123;@:3&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="源代码参考">1.2 源代码参考</h3>
<p><code>tools/train.py</code>负责训练指定模型。源代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> mmcv <span class="keyword">import</span> Config</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mmdet <span class="keyword">import</span> __version__</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> get_dataset</span><br><span class="line"><span class="keyword">from</span> mmdet.apis <span class="keyword">import</span> (train_detector, init_dist, get_root_logger,</span><br><span class="line">                        set_random_seed)</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> build_detector</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Train a detector&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;config&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;train config file path&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--work_dir&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;the dir to save logs and models&#x27;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--resume_from&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;the checkpoint file to resume from&#x27;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--validate&#x27;</span>,</span><br><span class="line">        action=<span class="string">&#x27;store_true&#x27;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&#x27;whether to evaluate the checkpoint during training&#x27;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--gpus&#x27;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">        default=<span class="number">1</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&#x27;number of gpus to use &#x27;</span></span><br><span class="line">        <span class="string">&#x27;(only applicable to non-distributed training)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--seed&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&#x27;random seed&#x27;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--launcher&#x27;</span>,</span><br><span class="line">        choices=[<span class="string">&#x27;none&#x27;</span>, <span class="string">&#x27;pytorch&#x27;</span>, <span class="string">&#x27;slurm&#x27;</span>, <span class="string">&#x27;mpi&#x27;</span>],</span><br><span class="line">        default=<span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&#x27;job launcher&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--local_rank&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">0</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    args = parse_args()</span><br><span class="line"></span><br><span class="line">    cfg = Config.fromfile(args.config)</span><br><span class="line">    <span class="comment"># set cudnn_benchmark</span></span><br><span class="line">    <span class="keyword">if</span> cfg.get(<span class="string">&#x27;cudnn_benchmark&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        torch.backends.cudnn.benchmark = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># update configs according to CLI args</span></span><br><span class="line">    <span class="keyword">if</span> args.work_dir <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        cfg.work_dir = args.work_dir</span><br><span class="line">    <span class="keyword">if</span> args.resume_from <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        cfg.resume_from = args.resume_from</span><br><span class="line">    cfg.gpus = args.gpus</span><br><span class="line">    <span class="keyword">if</span> cfg.checkpoint_config <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># save mmdet version in checkpoints as meta data</span></span><br><span class="line">        cfg.checkpoint_config.meta = <span class="built_in">dict</span>(</span><br><span class="line">            mmdet_version=__version__, config=cfg.text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># init distributed env first, since logger depends on the dist info.</span></span><br><span class="line">    <span class="keyword">if</span> args.launcher == <span class="string">&#x27;none&#x27;</span>:</span><br><span class="line">        distributed = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        distributed = <span class="literal">True</span></span><br><span class="line">        init_dist(args.launcher, **cfg.dist_params)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># init logger before other steps</span></span><br><span class="line">    logger = get_root_logger(cfg.log_level)</span><br><span class="line">    logger.info(<span class="string">&#x27;Distributed training: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(distributed))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set random seeds</span></span><br><span class="line">    <span class="keyword">if</span> args.seed <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logger.info(<span class="string">&#x27;Set random seed to &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(args.seed))</span><br><span class="line">        set_random_seed(args.seed)</span><br><span class="line"></span><br><span class="line">    model = build_detector(</span><br><span class="line">        cfg.model, train_cfg=cfg.train_cfg, test_cfg=cfg.test_cfg)</span><br><span class="line"></span><br><span class="line">    train_dataset = get_dataset(cfg.data.train)</span><br><span class="line">    train_detector(</span><br><span class="line">        model,</span><br><span class="line">        train_dataset,</span><br><span class="line">        cfg,</span><br><span class="line">        distributed=distributed,</span><br><span class="line">        validate=args.validate,</span><br><span class="line">        logger=logger)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="原理解析">1.3 原理解析</h3>
<h4 id="主要原理">1.3.1 主要原理</h4>
<p>本节对<code>tools/train.py</code>源代码执行的主要过程进行解释。对配置文件配置项和命令行参数的判断和设置略去。</p>
<p>首先，读取<code>config</code>文件（<code>configs\*.py</code>）并建立<code>mmcv.Config</code>对象以便后续解析：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfg = Config.fromfile(args.config)</span><br></pre></td></tr></table></figure>
<p>随后，调用<code>mmdet.models.build_detector</code>方法，输入配置信息，以建立模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model = build_detector(cfg.model, train_cfg=cfg.train_cfg, test_cfg=cfg.test_cfg)</span><br></pre></td></tr></table></figure>
<p>随后，调用<code>mmdet.datasets.get_dataset</code>方法，根据配置文件中写的训练集信息，建立训练集的数据集对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_dataset = get_dataset(cfg.data.train)</span><br></pre></td></tr></table></figure>
<p>最后，调用<code>mmdet.apis.train_detector</code>方法，输入已经构建好的模型<code>model</code>、训练集<code>train_dataset</code>、配置<code>config</code>对象以及其它参数，在训练集上训练该模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">train_detector(</span><br><span class="line">        model,</span><br><span class="line">        train_dataset,</span><br><span class="line">        cfg,</span><br><span class="line">        distributed=distributed,</span><br><span class="line">        validate=args.validate,</span><br><span class="line">        logger=logger)</span><br></pre></td></tr></table></figure>
<p>如果使用是分布式训练，且设置了<code>--validate</code>，会在训练中建立checkpoint的时候对该checkpoint进行评估。（未采用分布式训练时，<code>--validate</code>无效，因为<code>train_detector</code>中调用的<code>mmdet.apis._non_dist_train</code>函数未对<code>validate</code>参数做任何处理）。详情见以下1.3.2节。</p>
<h4 id="mmdet.api.train解析">1.3.2 <code>mmdet.api.train</code>解析</h4>
<p><code>mmdet.apis.train.py</code>源代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> Runner, DistSamplerSeedHook</span><br><span class="line"><span class="keyword">from</span> mmcv.parallel <span class="keyword">import</span> MMDataParallel, MMDistributedDataParallel</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> (DistOptimizerHook, DistEvalmAPHook,</span><br><span class="line">                        CocoDistEvalRecallHook, CocoDistEvalmAPHook)</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> build_dataloader</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> RPN</span><br><span class="line"><span class="keyword">from</span> .env <span class="keyword">import</span> get_root_logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_losses</span>(<span class="params">losses</span>):</span><br><span class="line">    log_vars = OrderedDict()</span><br><span class="line">    <span class="keyword">for</span> loss_name, loss_value <span class="keyword">in</span> losses.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(loss_value, torch.Tensor):</span><br><span class="line">            log_vars[loss_name] = loss_value.mean()</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(loss_value, <span class="built_in">list</span>):</span><br><span class="line">            log_vars[loss_name] = <span class="built_in">sum</span>(_loss.mean() <span class="keyword">for</span> _loss <span class="keyword">in</span> loss_value)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(</span><br><span class="line">                <span class="string">&#x27;&#123;&#125; is not a tensor or list of tensors&#x27;</span>.<span class="built_in">format</span>(loss_name))</span><br><span class="line"></span><br><span class="line">    loss = <span class="built_in">sum</span>(_value <span class="keyword">for</span> _key, _value <span class="keyword">in</span> log_vars.items() <span class="keyword">if</span> <span class="string">&#x27;loss&#x27;</span> <span class="keyword">in</span> _key)</span><br><span class="line"></span><br><span class="line">    log_vars[<span class="string">&#x27;loss&#x27;</span>] = loss</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> log_vars:</span><br><span class="line">        log_vars[name] = log_vars[name].item()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss, log_vars</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch_processor</span>(<span class="params">model, data, train_mode</span>):</span><br><span class="line">    losses = model(**data)</span><br><span class="line">    loss, log_vars = parse_losses(losses)</span><br><span class="line"></span><br><span class="line">    outputs = <span class="built_in">dict</span>(</span><br><span class="line">        loss=loss, log_vars=log_vars, num_samples=<span class="built_in">len</span>(data[<span class="string">&#x27;img&#x27;</span>].data))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_detector</span>(<span class="params">model,</span></span><br><span class="line"><span class="params">                   dataset,</span></span><br><span class="line"><span class="params">                   cfg,</span></span><br><span class="line"><span class="params">                   distributed=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">                   validate=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">                   logger=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> logger <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        logger = get_root_logger(cfg.log_level)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># start training</span></span><br><span class="line">    <span class="keyword">if</span> distributed:</span><br><span class="line">        _dist_train(model, dataset, cfg, validate=validate)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        _non_dist_train(model, dataset, cfg, validate=validate)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_dist_train</span>(<span class="params">model, dataset, cfg, validate=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="comment"># prepare data loaders</span></span><br><span class="line">    data_loaders = [</span><br><span class="line">        build_dataloader(</span><br><span class="line">            dataset,</span><br><span class="line">            cfg.data.imgs_per_gpu,</span><br><span class="line">            cfg.data.workers_per_gpu,</span><br><span class="line">            dist=<span class="literal">True</span>)</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># put model on gpus</span></span><br><span class="line">    model = MMDistributedDataParallel(model.cuda())</span><br><span class="line">    <span class="comment"># build runner</span></span><br><span class="line">    runner = Runner(model, batch_processor, cfg.optimizer, cfg.work_dir,</span><br><span class="line">                    cfg.log_level)</span><br><span class="line">    <span class="comment"># register hooks</span></span><br><span class="line">    optimizer_config = DistOptimizerHook(**cfg.optimizer_config)</span><br><span class="line">    runner.register_training_hooks(cfg.lr_config, optimizer_config,</span><br><span class="line">                                   cfg.checkpoint_config, cfg.log_config)</span><br><span class="line">    runner.register_hook(DistSamplerSeedHook())</span><br><span class="line">    <span class="comment"># register eval hooks</span></span><br><span class="line">    <span class="keyword">if</span> validate:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(model.module, RPN):</span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> implement recall hooks for other datasets</span></span><br><span class="line">            runner.register_hook(CocoDistEvalRecallHook(cfg.data.val))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> cfg.data.val.<span class="built_in">type</span> == <span class="string">&#x27;CocoDataset&#x27;</span>:</span><br><span class="line">                runner.register_hook(CocoDistEvalmAPHook(cfg.data.val))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                runner.register_hook(DistEvalmAPHook(cfg.data.val))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cfg.resume_from:</span><br><span class="line">        runner.resume(cfg.resume_from)</span><br><span class="line">    <span class="keyword">elif</span> cfg.load_from:</span><br><span class="line">        runner.load_checkpoint(cfg.load_from)</span><br><span class="line">    runner.run(data_loaders, cfg.workflow, cfg.total_epochs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_non_dist_train</span>(<span class="params">model, dataset, cfg, validate=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="comment"># prepare data loaders</span></span><br><span class="line">    data_loaders = [</span><br><span class="line">        build_dataloader(</span><br><span class="line">            dataset,</span><br><span class="line">            cfg.data.imgs_per_gpu,</span><br><span class="line">            cfg.data.workers_per_gpu,</span><br><span class="line">            cfg.gpus,</span><br><span class="line">            dist=<span class="literal">False</span>)</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># put model on gpus</span></span><br><span class="line">    model = MMDataParallel(model, device_ids=<span class="built_in">range</span>(cfg.gpus)).cuda()</span><br><span class="line">    <span class="comment"># build runner</span></span><br><span class="line">    runner = Runner(model, batch_processor, cfg.optimizer, cfg.work_dir,</span><br><span class="line">                    cfg.log_level)</span><br><span class="line">    runner.register_training_hooks(cfg.lr_config, cfg.optimizer_config,</span><br><span class="line">                                   cfg.checkpoint_config, cfg.log_config)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cfg.resume_from:</span><br><span class="line">        runner.resume(cfg.resume_from)</span><br><span class="line">    <span class="keyword">elif</span> cfg.load_from:</span><br><span class="line">        runner.load_checkpoint(cfg.load_from)</span><br><span class="line">    runner.run(data_loaders, cfg.workflow, cfg.total_epochs)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>train_detector</code>方法非常简短，通过是否分布式训练作为分支判断，分别调用：</p>
<ul>
<li><code>_dist_train</code>方法</li>
<li><code>_non_dist_train</code>方法</li>
</ul>
<p>均在同文件中实现。</p>
<h2 id="toolstest.py测试解析">2 <code>tools/test.py</code>测试解析</h2>
<p><code>tools/test.py</code>负责对训练好的模型进行测试评估。</p>
<h3 id="使用说明-1">2.1 使用说明</h3>
<h4 id="输出到文件">2.1.1 输出到文件</h4>
<p>在数据集上对训练好的模型进行测试，把模型的输出保存到文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python tools/test.py &lt;CONFIG_FILE&gt; &lt;CHECKPOINT_FILE&gt; --gpus &lt;GPU_NUM&gt; --out &lt;OUT_FILE&gt;</span><br></pre></td></tr></table></figure>
<h4 id="评估bbox等预测指标">2.1.2 评估<code>bbox</code>等预测指标</h4>
<p>使用8颗GPU对训练好的Mask
R-CNN模型进行测试，把模型输出保存到<code>results.pkl</code>并评估bbox和segm的测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python tools/test.py configs/mask_rcnn_r50_fpn_1x.py &lt;CHECKPOINT_FILE&gt; --gpus 8 --out results.pkl --<span class="built_in">eval</span> bbox segm</span><br></pre></td></tr></table></figure>
<p>我训练了一个简单的backbone为ResNet-50的Cascade
R-CNN模型，并使用以下命令进行测试评价：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUDA_VISIBLE_DEVICES=0 python tools/test.py configs/xray_cascade_rcnn_r50_fpn_1x.py work_dirs/xray/cascade_rcnn_r50_fpn_1x/latest.pth --out xray.pkl --<span class="built_in">eval</span> bbox</span><br></pre></td></tr></table></figure>
<p>显示结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(mmdetection) sjy@cjx:~/mmdetection$ CUDA_VISIBLE_DEVICES=0 python tools/test.py configs/xray_cascade_rcnn_r50_fpn_1x.py work_dirs/xray/cascade_rcnn_r50_fpn_1x/latest.pth --out xray.pkl --<span class="built_in">eval</span> bbox</span><br><span class="line">loading annotations into memory...</span><br><span class="line">Done (t=0.02s)</span><br><span class="line">creating index...</span><br><span class="line">index created!</span><br><span class="line">&#123;1: 1, 2: 2, 3: 3, 4: 4, 5: 5&#125;</span><br><span class="line">[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;] 178/178, 6.9 task/s, elapsed: 26s, ETA:     0swriting results to xray.pkl</span><br><span class="line">Starting evaluate bbox</span><br><span class="line">Loading and preparing results...</span><br><span class="line">DONE (t=0.06s)</span><br><span class="line">creating index...</span><br><span class="line">index created!</span><br><span class="line">Running per image evaluation...</span><br><span class="line">Evaluate annotation <span class="built_in">type</span> *bbox*</span><br><span class="line">DONE (t=0.53s).</span><br><span class="line">Accumulating evaluation results...</span><br><span class="line">DONE (t=0.08s).</span><br><span class="line"> Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.546</span><br><span class="line"> Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.843</span><br><span class="line"> Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.589</span><br><span class="line"> Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.605</span><br><span class="line"> Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = -1.000</span><br><span class="line"> Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = -1.000</span><br><span class="line"> Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.350</span><br><span class="line"> Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.607</span><br><span class="line"> Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.614</span><br><span class="line"> Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.614</span><br><span class="line"> Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = -1.000</span><br><span class="line"> Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = -1.000</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此处的格式化输出称为检测评价矩阵（<em>detection evaluation
metrics</em>）。</p>
<p>在底层实现上是在<code>mmdet.core.evaluation.coco_utils.py</code>中，<code>coco_eval</code>方法通过调用微软的COCO
API中的<code>pycocotools</code>包实现的。</p>
<p>以下节选<code>mmdet.core.evaluation.coco_utils.py</code>中<code>coco_eval</code>方法的实现代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> pycocotools.coco <span class="keyword">import</span> COCO</span><br><span class="line"><span class="keyword">from</span> pycocotools.cocoeval <span class="keyword">import</span> COCOeval</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .recall <span class="keyword">import</span> eval_recalls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">coco_eval</span>(<span class="params">result_file, result_types, coco, max_dets=(<span class="params"><span class="number">100</span>, <span class="number">300</span>, <span class="number">1000</span></span>)</span>):</span><br><span class="line">    <span class="keyword">for</span> res_type <span class="keyword">in</span> result_types:</span><br><span class="line">        <span class="keyword">assert</span> res_type <span class="keyword">in</span> [</span><br><span class="line">            <span class="string">&#x27;proposal&#x27;</span>, <span class="string">&#x27;proposal_fast&#x27;</span>, <span class="string">&#x27;bbox&#x27;</span>, <span class="string">&#x27;segm&#x27;</span>, <span class="string">&#x27;keypoints&#x27;</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mmcv.is_str(coco):</span><br><span class="line">        coco = COCO(coco)</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(coco, COCO)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result_types == [<span class="string">&#x27;proposal_fast&#x27;</span>]:</span><br><span class="line">        ar = fast_eval_recall(result_file, coco, np.array(max_dets))</span><br><span class="line">        <span class="keyword">for</span> i, num <span class="keyword">in</span> <span class="built_in">enumerate</span>(max_dets):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;AR@&#123;&#125;\t= &#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(num, ar[i]))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> result_file.endswith(<span class="string">&#x27;.json&#x27;</span>)</span><br><span class="line">    coco_dets = coco.loadRes(result_file)</span><br><span class="line"></span><br><span class="line">    img_ids = coco.getImgIds()</span><br><span class="line">    <span class="keyword">for</span> res_type <span class="keyword">in</span> result_types:</span><br><span class="line">        iou_type = <span class="string">&#x27;bbox&#x27;</span> <span class="keyword">if</span> res_type == <span class="string">&#x27;proposal&#x27;</span> <span class="keyword">else</span> res_type</span><br><span class="line">        cocoEval = COCOeval(coco, coco_dets, iou_type)</span><br><span class="line">        cocoEval.params.imgIds = img_ids</span><br><span class="line">        <span class="keyword">if</span> res_type == <span class="string">&#x27;proposal&#x27;</span>:</span><br><span class="line">            cocoEval.params.useCats = <span class="number">0</span></span><br><span class="line">            cocoEval.params.maxDets = <span class="built_in">list</span>(max_dets)</span><br><span class="line">        cocoEval.evaluate()</span><br><span class="line">        cocoEval.accumulate()</span><br><span class="line">        cocoEval.summarize()</span><br></pre></td></tr></table></figure>
<ul>
<li>通过构造COCOeval对象，配置参数，并依次调用<code>evaluate</code>、<code>accumulate</code>、<code>summarize</code>方法实现对数据集的测试评价。</li>
</ul>
<p>此处摘录COCO数据集文档中对该评价矩阵的简要说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Average Precision (AP):</span><br><span class="line">	AP		% AP at IoU=.50:.05:.95 (primary challenge metric) </span><br><span class="line">	APIoU=.50	% AP at IoU=.50 (PASCAL VOC metric) </span><br><span class="line">	APIoU=.75	% AP at IoU=.75 (strict metric)</span><br><span class="line">AP Across Scales:</span><br><span class="line">	APsmall		% AP for small objects: area &lt; 322 </span><br><span class="line">	APmedium	% AP for medium objects: 322 &lt; area &lt; 962 </span><br><span class="line">	APlarge		% AP for large objects: area &gt; 962</span><br><span class="line">Average Recall (AR):</span><br><span class="line">	ARmax=1		% AR given 1 detection per image </span><br><span class="line">	ARmax=10	% AR given 10 detections per image </span><br><span class="line">	ARmax=100	% AR given 100 detections per image</span><br><span class="line">AR Across Scales:</span><br><span class="line">	ARsmall		% AR for small objects: area &lt; 322 </span><br><span class="line">	ARmedium	% AR for medium objects: 322 &lt; area &lt; 962 </span><br><span class="line">	ARlarge		% AR for large objects: area &gt; 962</span><br></pre></td></tr></table></figure>
<p>对该矩阵的详细说明可参阅官方文档：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://cocodataset.org/#detection-eval">COCO Detection
Evaluation</a></p>
</blockquote>
<h4 id="可视化预测结果">2.1.3 可视化预测结果</h4>
<p>如果支持X
Server，可以显示图形界面，则可以通过<code>--show</code>选项对测试图片进行显示输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python tools/test.py &lt;CONFIG_FILE&gt; &lt;CHECKPOINT_FILE&gt; --show</span><br></pre></td></tr></table></figure>
<p>可以通过安装MobaXterm在Windows上SSH连接Linux服务器并实现X
Server的远程图形显示功能。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://mobaxterm.mobatek.net">MobaXterm</a></p>
<p>Enhanced terminal for Windows with X11 server, tabbed SSH client,
network tools and much more</p>
</blockquote>
<h3 id="源代码参考-1">2.2 源代码参考</h3>
<p><code>tools/test.py</code>源代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> load_checkpoint, parallel_test, obj_from_dict</span><br><span class="line"><span class="keyword">from</span> mmcv.parallel <span class="keyword">import</span> scatter, collate, MMDataParallel</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mmdet <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> results2json, coco_eval</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> build_dataloader</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> build_detector, detectors</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">single_test</span>(<span class="params">model, data_loader, show=<span class="literal">False</span></span>):</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    results = []</span><br><span class="line">    dataset = data_loader.dataset</span><br><span class="line">    prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(dataset))</span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            result = model(return_loss=<span class="literal">False</span>, rescale=<span class="keyword">not</span> show, **data)</span><br><span class="line">        results.append(result)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> show:</span><br><span class="line">            model.module.show_result(data, result, dataset.img_norm_cfg,</span><br><span class="line">                                     dataset=dataset.CLASSES)</span><br><span class="line"></span><br><span class="line">        batch_size = data[<span class="string">&#x27;img&#x27;</span>][<span class="number">0</span>].size(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(batch_size):</span><br><span class="line">            prog_bar.update()</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_data_func</span>(<span class="params">data, device_id</span>):</span><br><span class="line">    data = scatter(collate([data], samples_per_gpu=<span class="number">1</span>), [device_id])[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(return_loss=<span class="literal">False</span>, rescale=<span class="literal">True</span>, **data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;MMDet test detector&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;config&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;test config file path&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;checkpoint&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;checkpoint file&#x27;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--gpus&#x27;</span>, default=<span class="number">1</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&#x27;GPU number used for testing&#x27;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--proc_per_gpu&#x27;</span>,</span><br><span class="line">        default=<span class="number">1</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&#x27;Number of processes per GPU&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--out&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;output result file&#x27;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&#x27;--eval&#x27;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">        nargs=<span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">        choices=[<span class="string">&#x27;proposal&#x27;</span>, <span class="string">&#x27;proposal_fast&#x27;</span>, <span class="string">&#x27;bbox&#x27;</span>, <span class="string">&#x27;segm&#x27;</span>, <span class="string">&#x27;keypoints&#x27;</span>],</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&#x27;eval types&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--show&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;show results&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    args = parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.out <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> args.out.endswith((<span class="string">&#x27;.pkl&#x27;</span>, <span class="string">&#x27;.pickle&#x27;</span>)):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;The output file must be a pkl file.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cfg = mmcv.Config.fromfile(args.config)</span><br><span class="line">    <span class="comment"># set cudnn_benchmark</span></span><br><span class="line">    <span class="keyword">if</span> cfg.get(<span class="string">&#x27;cudnn_benchmark&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        torch.backends.cudnn.benchmark = <span class="literal">True</span></span><br><span class="line">    cfg.model.pretrained = <span class="literal">None</span></span><br><span class="line">    cfg.data.test.test_mode = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    dataset = obj_from_dict(cfg.data.test, datasets, <span class="built_in">dict</span>(test_mode=<span class="literal">True</span>))</span><br><span class="line">    <span class="keyword">if</span> args.gpus == <span class="number">1</span>:</span><br><span class="line">        model = build_detector(</span><br><span class="line">            cfg.model, train_cfg=<span class="literal">None</span>, test_cfg=cfg.test_cfg)</span><br><span class="line">        load_checkpoint(model, args.checkpoint)</span><br><span class="line">        model = MMDataParallel(model, device_ids=[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        data_loader = build_dataloader(</span><br><span class="line">            dataset,</span><br><span class="line">            imgs_per_gpu=<span class="number">1</span>,</span><br><span class="line">            workers_per_gpu=cfg.data.workers_per_gpu,</span><br><span class="line">            num_gpus=<span class="number">1</span>,</span><br><span class="line">            dist=<span class="literal">False</span>,</span><br><span class="line">            shuffle=<span class="literal">False</span>)</span><br><span class="line">        outputs = single_test(model, data_loader, args.show)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        model_args = cfg.model.copy()</span><br><span class="line">        model_args.update(train_cfg=<span class="literal">None</span>, test_cfg=cfg.test_cfg)</span><br><span class="line">        model_type = <span class="built_in">getattr</span>(detectors, model_args.pop(<span class="string">&#x27;type&#x27;</span>))</span><br><span class="line">        outputs = parallel_test(</span><br><span class="line">            model_type,</span><br><span class="line">            model_args,</span><br><span class="line">            args.checkpoint,</span><br><span class="line">            dataset,</span><br><span class="line">            _data_func,</span><br><span class="line">            <span class="built_in">range</span>(args.gpus),</span><br><span class="line">            workers_per_gpu=args.proc_per_gpu)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.out:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;writing results to &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(args.out))</span><br><span class="line">        mmcv.dump(outputs, args.out)</span><br><span class="line">        eval_types = args.<span class="built_in">eval</span></span><br><span class="line">        <span class="keyword">if</span> eval_types:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Starting evaluate &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27; and &#x27;</span>.join(eval_types)))</span><br><span class="line">            <span class="keyword">if</span> eval_types == [<span class="string">&#x27;proposal_fast&#x27;</span>]:</span><br><span class="line">                result_file = args.out</span><br><span class="line">                coco_eval(result_file, eval_types, dataset.coco)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(outputs[<span class="number">0</span>], <span class="built_in">dict</span>):</span><br><span class="line">                    result_file = args.out + <span class="string">&#x27;.json&#x27;</span></span><br><span class="line">                    results2json(dataset, outputs, result_file)</span><br><span class="line">                    coco_eval(result_file, eval_types, dataset.coco)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">for</span> name <span class="keyword">in</span> outputs[<span class="number">0</span>]:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;\nEvaluating &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">                        outputs_ = [out[name] <span class="keyword">for</span> out <span class="keyword">in</span> outputs]</span><br><span class="line">                        result_file = args.out + <span class="string">&#x27;.&#123;&#125;.json&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">                        results2json(dataset, outputs_, result_file)</span><br><span class="line">                        coco_eval(result_file, eval_types, dataset.coco)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="原理解析-1">2.3 原理解析</h3>
<h4 id="主要原理-1">2.3.1 主要原理</h4>
<p>首先，读取配置文件，构造<code>Config</code>类对象<code>cfg</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfg = mmcv.Config.fromfile(args.config)</span><br></pre></td></tr></table></figure>
<p>随后，通过<code>mmcv.runner.obj_from_dict</code>方法读取配置文件中关于测试集的配置，构建数据集对象<code>dataset</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataset = obj_from_dict(cfg.data.test, datasets, <span class="built_in">dict</span>(test_mode=<span class="literal">True</span>))</span><br></pre></td></tr></table></figure>
<p>随后，以单颗GPU的情况（<code>args.gpus == 1</code>）为例，将通过<code>mmdet.models.build_detector</code>方法，读取模型配置，设置训练配置为<code>None</code>，并传入测试配置，构造待测试模型<code>model</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model = build_detector(cfg.model, train_cfg=<span class="literal">None</span>, test_cfg=cfg.test_cfg)</span><br></pre></td></tr></table></figure>
<p>随后，通过<code>mmcv.runner.load_checkpoint</code>方法，读取模型训练取得的checkpoint以配置模型中的参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_checkpoint(model, args.checkpoint)</span><br></pre></td></tr></table></figure>
<p>随后，通过<code>mmcv.parallel.MMDataParallel</code>方法，在设备上构建非分布式计算的模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model = MMDataParallel(model, device_ids=[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>mmdetection implements distributed training and non-distributed
training, which uses <code>MMDistributedDataParallel</code> and
<code>MMDataParallel</code> respectively.</p>
<p>(README.md)</p>
</blockquote>
<p>随后，通过<code>mmdet.datasets.build_dataloader</code>方法，根据数据集对象<code>dataset</code>构造数据加载器对象<code>data_loader</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data_loader = build_dataloader(</span><br><span class="line">            dataset,</span><br><span class="line">            imgs_per_gpu=<span class="number">1</span>,</span><br><span class="line">            workers_per_gpu=cfg.data.workers_per_gpu,</span><br><span class="line">            num_gpus=<span class="number">1</span>,</span><br><span class="line">            dist=<span class="literal">False</span>,</span><br><span class="line">            shuffle=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>最后，通过调用同文件中定义的<code>single_test</code>方法，输入模型对象<code>model</code>、数据加载器<code>data_loader</code>等配置实现单GPU设备上对模型的测试输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outputs = single_test(model, data_loader, args.show)</span><br></pre></td></tr></table></figure>
<h4 id="single_test单设备测试">2.3.2
<code>single_test</code>单设备测试</h4>
<p>在该<code>single_test</code>方法中，实际通过以下的几个主要步骤对模型进行测试输出。</p>
<p>首先，通过<code>torch.nn.Module.eval</code>方法，将该模型设置进入评价模式（<em>evaluation
mode</em>）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.<span class="built_in">eval</span>()</span><br></pre></td></tr></table></figure>
<p>随后，通过遍历数据加载器<code>data_loader</code>读取数据，按照PyTorch的标准流程，取消梯度计算，输入数据运行模型，并取得模型输出（同时处理好X
Server中图片目标检测结果可视化和Shell中进度条刷新事宜）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        result = model(return_loss=<span class="literal">False</span>, rescale=<span class="keyword">not</span> show, **data)</span><br><span class="line">    results.append(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> show:</span><br><span class="line">        model.module.show_result(data, result, dataset.img_norm_cfg,</span><br><span class="line">                                    dataset=dataset.CLASSES)</span><br><span class="line"></span><br><span class="line">    batch_size = data[<span class="string">&#x27;img&#x27;</span>][<span class="number">0</span>].size(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(batch_size):</span><br><span class="line">        prog_bar.update()</span><br></pre></td></tr></table></figure>
<h2 id="models模型实现解析">3 <code>models</code>模型实现解析</h2>
<blockquote>
<p>以下内容摘选自：<a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection/blob/master/TECHNICAL_DETAILS.md">mmdetection
/ <strong>TECHNICAL_DETAILS.md</strong></a></p>
<p><strong>Model</strong></p>
<p>In mmdetection, model components are basically categorized as 4
types.</p>
<ul>
<li>backbone: usually a FCN network to extract feature maps, e.g.,
ResNet.</li>
<li>neck: the part between backbones and heads, e.g., FPN, ASPP.</li>
<li>head: the part for specific tasks, e.g., bbox prediction and mask
prediction.</li>
<li>roi extractor: the part for extracting features from feature maps,
e.g., RoI Align.</li>
</ul>
<p>We also write implement some general detection pipelines with the
above components, such as <code>SingleStageDetector</code> and
<code>TwoStageDetector</code>.</p>
</blockquote>
<p>在mmdetection中，模型基本上分为四个部分，形象地称为：</p>
<ul>
<li>骨干（<em>backbone</em>）：通常通过全连接网络来提取特征映射图，例如：ResNet。</li>
<li>脖颈（<em>neck</em>）：连接骨干和头的部分，例如：FPN、ASPP。</li>
<li>头（<em>head</em>）：用于特定任务，例如：候选框的预测、掩膜的预测。</li>
<li>兴趣区域提取器（<em>RoI
extractor</em>）：该部分组件用于在特征映射图上提取特征，例如：RoI
Align。</li>
</ul>
<p>在官方的技术细节说明中，我们可以从<code>SingleStageDetector</code>和<code>TwoStageDetector</code>这两个类的实现中来阅读代码理解mmdetection框架中，基本目标检测模型的实现原理。</p>
<p><code>SingleStageDetector</code>和<code>TwoStageDetector</code>均位于<code>mmdet.models.detectors</code>中，分别在<code>single_stage.py</code>和<code>two_stage.py</code>中实现。</p>
<h3 id="single_stage.py解析">3.1 <code>single_stage.py</code>解析</h3>
<h4 id="源代码参考-2">3.1.1 源代码参考</h4>
<p><code>mmdet/models/detectors/single_stage.py</code>实现了一个通用的基础单Stage目标检测模型，源代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> BaseDetector</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> builder</span><br><span class="line"><span class="keyword">from</span> ..registry <span class="keyword">import</span> DETECTORS</span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> bbox2result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DETECTORS.register_module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingleStageDetector</span>(<span class="title class_ inherited__">BaseDetector</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 backbone,</span></span><br><span class="line"><span class="params">                 neck=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 bbox_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 train_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 test_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 pretrained=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SingleStageDetector, self).__init__()</span><br><span class="line">        self.backbone = builder.build_backbone(backbone)</span><br><span class="line">        <span class="keyword">if</span> neck <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.neck = builder.build_neck(neck)</span><br><span class="line">        self.bbox_head = builder.build_head(bbox_head)</span><br><span class="line">        self.train_cfg = train_cfg</span><br><span class="line">        self.test_cfg = test_cfg</span><br><span class="line">        self.init_weights(pretrained=pretrained)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_weights</span>(<span class="params">self, pretrained=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SingleStageDetector, self).init_weights(pretrained)</span><br><span class="line">        self.backbone.init_weights(pretrained=pretrained)</span><br><span class="line">        <span class="keyword">if</span> self.with_neck:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(self.neck, nn.Sequential):</span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> self.neck:</span><br><span class="line">                    m.init_weights()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.neck.init_weights()</span><br><span class="line">        self.bbox_head.init_weights()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_feat</span>(<span class="params">self, img</span>):</span><br><span class="line">        x = self.backbone(img)</span><br><span class="line">        <span class="keyword">if</span> self.with_neck:</span><br><span class="line">            x = self.neck(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_train</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                      img,</span></span><br><span class="line"><span class="params">                      img_metas,</span></span><br><span class="line"><span class="params">                      gt_bboxes,</span></span><br><span class="line"><span class="params">                      gt_labels,</span></span><br><span class="line"><span class="params">                      gt_bboxes_ignore=<span class="literal">None</span></span>):</span><br><span class="line">        x = self.extract_feat(img)</span><br><span class="line">        outs = self.bbox_head(x)</span><br><span class="line">        loss_inputs = outs + (gt_bboxes, gt_labels, img_metas, self.train_cfg)</span><br><span class="line">        losses = self.bbox_head.loss(</span><br><span class="line">            *loss_inputs, gt_bboxes_ignore=gt_bboxes_ignore)</span><br><span class="line">        <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">simple_test</span>(<span class="params">self, img, img_meta, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        x = self.extract_feat(img)</span><br><span class="line">        outs = self.bbox_head(x)</span><br><span class="line">        bbox_inputs = outs + (img_meta, self.test_cfg, rescale)</span><br><span class="line">        bbox_list = self.bbox_head.get_bboxes(*bbox_inputs)</span><br><span class="line">        bbox_results = [</span><br><span class="line">            bbox2result(det_bboxes, det_labels, self.bbox_head.num_classes)</span><br><span class="line">            <span class="keyword">for</span> det_bboxes, det_labels <span class="keyword">in</span> bbox_list</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">return</span> bbox_results[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">aug_test</span>(<span class="params">self, imgs, img_metas, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="原理解析-2">3.1.2 原理解析</h4>
<p>可以看到，对于<code>SingleStageDetector</code>通过继承基础类<code>BaseDetector</code>来实现单Stage的目标检测模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DETECTORS.register_module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingleStageDetector</span>(<span class="title class_ inherited__">BaseDetector</span>):</span><br></pre></td></tr></table></figure>
<p>函数<code>__init__</code>定义模型的数据结构和数据初始化：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">             backbone,</span></span><br><span class="line"><span class="params">             neck=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             bbox_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             train_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             test_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             pretrained=<span class="literal">None</span></span>):</span><br></pre></td></tr></table></figure>
<p>函数<code>forward_train</code>定义模型的前向传播训练，输出为训练时的损失<code>losses</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">forward_train</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                  img,</span></span><br><span class="line"><span class="params">                  img_metas,</span></span><br><span class="line"><span class="params">                  gt_bboxes,</span></span><br><span class="line"><span class="params">                  gt_labels,</span></span><br><span class="line"><span class="params">                  gt_bboxes_ignore=<span class="literal">None</span></span>):</span><br></pre></td></tr></table></figure>
<p>函数<code>simple_test</code>定义模型的测试评价所需要执行的内容，输出为模型预测的边界框结果<code>bbox_results</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_test</span>(<span class="params">self, img, img_meta, rescale=<span class="literal">False</span></span>):</span><br><span class="line">    x = self.extract_feat(img)</span><br><span class="line">    outs = self.bbox_head(x)</span><br><span class="line">    bbox_inputs = outs + (img_meta, self.test_cfg, rescale)</span><br><span class="line">    bbox_list = self.bbox_head.get_bboxes(*bbox_inputs)</span><br><span class="line">    bbox_results = [</span><br><span class="line">        bbox2result(det_bboxes, det_labels, self.bbox_head.num_classes)</span><br><span class="line">        <span class="keyword">for</span> det_bboxes, det_labels <span class="keyword">in</span> bbox_list</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> bbox_results[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>根据代码实现，可以看到：<code>bbox_results</code>是通过Python的列表推导式，遍历数据并调用<code>bbox2result</code>函数，根据该函数的返回值填充出的。</p>
<p><code>bbox_results</code>中包含以下信息：</p>
<ul>
<li>模型目标检测输出的边界框<code>det_bboxes</code></li>
<li>各框的预测标记信息结合出的结果<code>det_labels</code></li>
</ul>
<h3 id="two_stage.py解析">3.2 <code>two_stage.py</code>解析</h3>
<h4 id="源代码参考-3">3.2.1 源代码参考</h4>
<p><code>mmdet/models/detectors/two_stage.py</code>实现了一个通用的基础双Stage目标检测模型。相较于单Stage模型，双Stage模型增加了目标实例（<em>instance</em>）的掩膜（<em>mask</em>）输出，即增加了实例分割（<em>instance
segmentation</em>）的功能。</p>
<p>源代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> BaseDetector</span><br><span class="line"><span class="keyword">from</span> .test_mixins <span class="keyword">import</span> RPNTestMixin, BBoxTestMixin, MaskTestMixin</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> builder</span><br><span class="line"><span class="keyword">from</span> ..registry <span class="keyword">import</span> DETECTORS</span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> bbox2roi, bbox2result, build_assigner, build_sampler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@DETECTORS.register_module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoStageDetector</span>(BaseDetector, RPNTestMixin, BBoxTestMixin,</span><br><span class="line">                       MaskTestMixin):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 backbone,</span></span><br><span class="line"><span class="params">                 neck=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 rpn_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 bbox_roi_extractor=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 bbox_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 mask_roi_extractor=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 mask_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 train_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 test_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 pretrained=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(TwoStageDetector, self).__init__()</span><br><span class="line">        self.backbone = builder.build_backbone(backbone)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> neck <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.neck = builder.build_neck(neck)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> rpn_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.rpn_head = builder.build_head(rpn_head)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> bbox_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.bbox_roi_extractor = builder.build_roi_extractor(</span><br><span class="line">                bbox_roi_extractor)</span><br><span class="line">            self.bbox_head = builder.build_head(bbox_head)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mask_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.mask_roi_extractor = builder.build_roi_extractor(</span><br><span class="line">                mask_roi_extractor)</span><br><span class="line">            self.mask_head = builder.build_head(mask_head)</span><br><span class="line"></span><br><span class="line">        self.train_cfg = train_cfg</span><br><span class="line">        self.test_cfg = test_cfg</span><br><span class="line"></span><br><span class="line">        self.init_weights(pretrained=pretrained)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">with_rpn</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;rpn_head&#x27;</span>) <span class="keyword">and</span> self.rpn_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_weights</span>(<span class="params">self, pretrained=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(TwoStageDetector, self).init_weights(pretrained)</span><br><span class="line">        self.backbone.init_weights(pretrained=pretrained)</span><br><span class="line">        <span class="keyword">if</span> self.with_neck:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(self.neck, nn.Sequential):</span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> self.neck:</span><br><span class="line">                    m.init_weights()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.neck.init_weights()</span><br><span class="line">        <span class="keyword">if</span> self.with_rpn:</span><br><span class="line">            self.rpn_head.init_weights()</span><br><span class="line">        <span class="keyword">if</span> self.with_bbox:</span><br><span class="line">            self.bbox_roi_extractor.init_weights()</span><br><span class="line">            self.bbox_head.init_weights()</span><br><span class="line">        <span class="keyword">if</span> self.with_mask:</span><br><span class="line">            self.mask_roi_extractor.init_weights()</span><br><span class="line">            self.mask_head.init_weights()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_feat</span>(<span class="params">self, img</span>):</span><br><span class="line">        x = self.backbone(img)</span><br><span class="line">        <span class="keyword">if</span> self.with_neck:</span><br><span class="line">            x = self.neck(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_train</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                      img,</span></span><br><span class="line"><span class="params">                      img_meta,</span></span><br><span class="line"><span class="params">                      gt_bboxes,</span></span><br><span class="line"><span class="params">                      gt_labels,</span></span><br><span class="line"><span class="params">                      gt_bboxes_ignore=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      gt_masks=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                      proposals=<span class="literal">None</span></span>):</span><br><span class="line">        x = self.extract_feat(img)</span><br><span class="line"></span><br><span class="line">        losses = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># RPN forward and loss</span></span><br><span class="line">        <span class="keyword">if</span> self.with_rpn:</span><br><span class="line">            rpn_outs = self.rpn_head(x)</span><br><span class="line">            rpn_loss_inputs = rpn_outs + (gt_bboxes, img_meta,</span><br><span class="line">                                          self.train_cfg.rpn)</span><br><span class="line">            rpn_losses = self.rpn_head.loss(</span><br><span class="line">                *rpn_loss_inputs, gt_bboxes_ignore=gt_bboxes_ignore)</span><br><span class="line">            losses.update(rpn_losses)</span><br><span class="line"></span><br><span class="line">            proposal_inputs = rpn_outs + (img_meta, self.test_cfg.rpn)</span><br><span class="line">            proposal_list = self.rpn_head.get_bboxes(*proposal_inputs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            proposal_list = proposals</span><br><span class="line"></span><br><span class="line">        <span class="comment"># assign gts and sample proposals</span></span><br><span class="line">        <span class="keyword">if</span> self.with_bbox <span class="keyword">or</span> self.with_mask:</span><br><span class="line">            bbox_assigner = build_assigner(self.train_cfg.rcnn.assigner)</span><br><span class="line">            bbox_sampler = build_sampler(</span><br><span class="line">                self.train_cfg.rcnn.sampler, context=self)</span><br><span class="line">            num_imgs = img.size(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> gt_bboxes_ignore <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                gt_bboxes_ignore = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_imgs)]</span><br><span class="line">            sampling_results = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_imgs):</span><br><span class="line">                assign_result = bbox_assigner.assign(</span><br><span class="line">                    proposal_list[i], gt_bboxes[i], gt_bboxes_ignore[i],</span><br><span class="line">                    gt_labels[i])</span><br><span class="line">                sampling_result = bbox_sampler.sample(</span><br><span class="line">                    assign_result,</span><br><span class="line">                    proposal_list[i],</span><br><span class="line">                    gt_bboxes[i],</span><br><span class="line">                    gt_labels[i],</span><br><span class="line">                    feats=[lvl_feat[i][<span class="literal">None</span>] <span class="keyword">for</span> lvl_feat <span class="keyword">in</span> x])</span><br><span class="line">                sampling_results.append(sampling_result)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># bbox head forward and loss</span></span><br><span class="line">        <span class="keyword">if</span> self.with_bbox:</span><br><span class="line">            rois = bbox2roi([res.bboxes <span class="keyword">for</span> res <span class="keyword">in</span> sampling_results])</span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> a more flexible way to decide which feature maps to use</span></span><br><span class="line">            bbox_feats = self.bbox_roi_extractor(</span><br><span class="line">                x[:self.bbox_roi_extractor.num_inputs], rois)</span><br><span class="line">            cls_score, bbox_pred = self.bbox_head(bbox_feats)</span><br><span class="line"></span><br><span class="line">            bbox_targets = self.bbox_head.get_target(</span><br><span class="line">                sampling_results, gt_bboxes, gt_labels, self.train_cfg.rcnn)</span><br><span class="line">            loss_bbox = self.bbox_head.loss(cls_score, bbox_pred,</span><br><span class="line">                                            *bbox_targets)</span><br><span class="line">            losses.update(loss_bbox)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># mask head forward and loss</span></span><br><span class="line">        <span class="keyword">if</span> self.with_mask:</span><br><span class="line">            pos_rois = bbox2roi([res.pos_bboxes <span class="keyword">for</span> res <span class="keyword">in</span> sampling_results])</span><br><span class="line">            mask_feats = self.mask_roi_extractor(</span><br><span class="line">                x[:self.mask_roi_extractor.num_inputs], pos_rois)</span><br><span class="line">            mask_pred = self.mask_head(mask_feats)</span><br><span class="line"></span><br><span class="line">            mask_targets = self.mask_head.get_target(</span><br><span class="line">                sampling_results, gt_masks, self.train_cfg.rcnn)</span><br><span class="line">            pos_labels = torch.cat(</span><br><span class="line">                [res.pos_gt_labels <span class="keyword">for</span> res <span class="keyword">in</span> sampling_results])</span><br><span class="line">            loss_mask = self.mask_head.loss(mask_pred, mask_targets,</span><br><span class="line">                                            pos_labels)</span><br><span class="line">            losses.update(loss_mask)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">simple_test</span>(<span class="params">self, img, img_meta, proposals=<span class="literal">None</span>, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test without augmentation.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> self.with_bbox, <span class="string">&quot;Bbox head must be implemented.&quot;</span></span><br><span class="line"></span><br><span class="line">        x = self.extract_feat(img)</span><br><span class="line"></span><br><span class="line">        proposal_list = self.simple_test_rpn(</span><br><span class="line">            x, img_meta, self.test_cfg.rpn) <span class="keyword">if</span> proposals <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> proposals</span><br><span class="line"></span><br><span class="line">        det_bboxes, det_labels = self.simple_test_bboxes(</span><br><span class="line">            x, img_meta, proposal_list, self.test_cfg.rcnn, rescale=rescale)</span><br><span class="line">        bbox_results = bbox2result(det_bboxes, det_labels,</span><br><span class="line">                                   self.bbox_head.num_classes)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.with_mask:</span><br><span class="line">            <span class="keyword">return</span> bbox_results</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            segm_results = self.simple_test_mask(</span><br><span class="line">                x, img_meta, det_bboxes, det_labels, rescale=rescale)</span><br><span class="line">            <span class="keyword">return</span> bbox_results, segm_results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">aug_test</span>(<span class="params">self, imgs, img_metas, rescale=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test with augmentations.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        If rescale is False, then returned bboxes and masks will fit the scale</span></span><br><span class="line"><span class="string">        of imgs[0].</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># recompute feats to save memory</span></span><br><span class="line">        proposal_list = self.aug_test_rpn(</span><br><span class="line">            self.extract_feats(imgs), img_metas, self.test_cfg.rpn)</span><br><span class="line">        det_bboxes, det_labels = self.aug_test_bboxes(</span><br><span class="line">            self.extract_feats(imgs), img_metas, proposal_list,</span><br><span class="line">            self.test_cfg.rcnn)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> rescale:</span><br><span class="line">            _det_bboxes = det_bboxes</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            _det_bboxes = det_bboxes.clone()</span><br><span class="line">            _det_bboxes[:, :<span class="number">4</span>] *= img_metas[<span class="number">0</span>][<span class="number">0</span>][<span class="string">&#x27;scale_factor&#x27;</span>]</span><br><span class="line">        bbox_results = bbox2result(_det_bboxes, det_labels,</span><br><span class="line">                                   self.bbox_head.num_classes)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># det_bboxes always keep the original scale</span></span><br><span class="line">        <span class="keyword">if</span> self.with_mask:</span><br><span class="line">            segm_results = self.aug_test_mask(</span><br><span class="line">                self.extract_feats(imgs), img_metas, det_bboxes, det_labels)</span><br><span class="line">            <span class="keyword">return</span> bbox_results, segm_results</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> bbox_results</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="原理解析-3">3.2.2 原理解析</h4>
<p>可以看到，<code>TwoStageDetector</code>通过继承基础类<code>BaseDetector</code>以及RPN等类来实现双Stage的目标检测模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DETECTORS.register_module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoStageDetector</span>(BaseDetector, RPNTestMixin, BBoxTestMixin,</span><br><span class="line">                       MaskTestMixin):</span><br></pre></td></tr></table></figure>
<p>函数<code>__init__</code>定义模型的数据结构和数据初始化：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">             backbone,</span></span><br><span class="line"><span class="params">             neck=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             rpn_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             bbox_roi_extractor=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             bbox_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             mask_roi_extractor=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             mask_head=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             train_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             test_cfg=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">             pretrained=<span class="literal">None</span></span>):</span><br></pre></td></tr></table></figure>
<p>函数<code>forward_train</code>定义模型的前向传播训练，输出为训练时的损失<code>losses</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">forward_train</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                  img,</span></span><br><span class="line"><span class="params">                  img_meta,</span></span><br><span class="line"><span class="params">                  gt_bboxes,</span></span><br><span class="line"><span class="params">                  gt_labels,</span></span><br><span class="line"><span class="params">                  gt_bboxes_ignore=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                  gt_masks=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                  proposals=<span class="literal">None</span></span>):</span><br></pre></td></tr></table></figure>
<p>函数<code>simple_test</code>定义模型的测试评价所需要执行的内容，输出为模型预测的边界框结果<code>bbox_results</code>和<code>segm_results</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_test</span>(<span class="params">self, img, img_meta, proposals=<span class="literal">None</span>, rescale=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Test without augmentation.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> self.with_bbox, <span class="string">&quot;Bbox head must be implemented.&quot;</span></span><br><span class="line"></span><br><span class="line">    x = self.extract_feat(img)</span><br><span class="line"></span><br><span class="line">    proposal_list = self.simple_test_rpn(</span><br><span class="line">        x, img_meta, self.test_cfg.rpn) <span class="keyword">if</span> proposals <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> proposals</span><br><span class="line"></span><br><span class="line">    det_bboxes, det_labels = self.simple_test_bboxes(</span><br><span class="line">        x, img_meta, proposal_list, self.test_cfg.rcnn, rescale=rescale)</span><br><span class="line">    bbox_results = bbox2result(det_bboxes, det_labels,</span><br><span class="line">                               self.bbox_head.num_classes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.with_mask:</span><br><span class="line">        <span class="keyword">return</span> bbox_results</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        segm_results = self.simple_test_mask(</span><br><span class="line">            x, img_meta, det_bboxes, det_labels, rescale=rescale)</span><br><span class="line">        <span class="keyword">return</span> bbox_results, segm_results</span><br></pre></td></tr></table></figure>
<p>根据代码实现，可以看到：<code>bbox_results</code>是通过Python的列表推导式，遍历数据并调用<code>bbox2result</code>函数，根据该函数的返回值填充出的。</p>
<p><code>bbox_results</code>中包含以下信息：</p>
<ul>
<li>模型目标检测输出的边界框<code>det_bboxes</code></li>
<li>各框的预测标记信息结合出的结果<code>det_labels</code></li>
</ul>
<p>另外，双Stage模型还输出了目标实例的掩膜预测结果<code>segm_results</code>。</p>
<h2 id="自定义数据集解析">4 自定义数据集解析</h2>
<h3 id="coco.py解析">4.1 <code>coco.py</code>解析</h3>
<h4 id="源代码参考-4">4.1.1 源代码参考</h4>
<p><code>coco.py</code>位于<code>mmdet.datasets</code>中，实现<code>CocoDataset</code>类，并实现了一系列对COCO数据集读取解析的类成员方法。<code>coco.py</code>源代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> pycocotools.coco <span class="keyword">import</span> COCO</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .custom <span class="keyword">import</span> CustomDataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CocoDataset</span>(<span class="title class_ inherited__">CustomDataset</span>):</span><br><span class="line"></span><br><span class="line">    CLASSES = (<span class="string">&#x27;person&#x27;</span>, <span class="string">&#x27;bicycle&#x27;</span>, <span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;motorcycle&#x27;</span>, <span class="string">&#x27;airplane&#x27;</span>, <span class="string">&#x27;bus&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;truck&#x27;</span>, <span class="string">&#x27;boat&#x27;</span>, <span class="string">&#x27;traffic_light&#x27;</span>, <span class="string">&#x27;fire_hydrant&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;stop_sign&#x27;</span>, <span class="string">&#x27;parking_meter&#x27;</span>, <span class="string">&#x27;bench&#x27;</span>, <span class="string">&#x27;bird&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;horse&#x27;</span>, <span class="string">&#x27;sheep&#x27;</span>, <span class="string">&#x27;cow&#x27;</span>, <span class="string">&#x27;elephant&#x27;</span>, <span class="string">&#x27;bear&#x27;</span>, <span class="string">&#x27;zebra&#x27;</span>, <span class="string">&#x27;giraffe&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;backpack&#x27;</span>, <span class="string">&#x27;umbrella&#x27;</span>, <span class="string">&#x27;handbag&#x27;</span>, <span class="string">&#x27;tie&#x27;</span>, <span class="string">&#x27;suitcase&#x27;</span>, <span class="string">&#x27;frisbee&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;skis&#x27;</span>, <span class="string">&#x27;snowboard&#x27;</span>, <span class="string">&#x27;sports_ball&#x27;</span>, <span class="string">&#x27;kite&#x27;</span>, <span class="string">&#x27;baseball_bat&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;baseball_glove&#x27;</span>, <span class="string">&#x27;skateboard&#x27;</span>, <span class="string">&#x27;surfboard&#x27;</span>, <span class="string">&#x27;tennis_racket&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;bottle&#x27;</span>, <span class="string">&#x27;wine_glass&#x27;</span>, <span class="string">&#x27;cup&#x27;</span>, <span class="string">&#x27;fork&#x27;</span>, <span class="string">&#x27;knife&#x27;</span>, <span class="string">&#x27;spoon&#x27;</span>, <span class="string">&#x27;bowl&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;banana&#x27;</span>, <span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;sandwich&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>, <span class="string">&#x27;broccoli&#x27;</span>, <span class="string">&#x27;carrot&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;hot_dog&#x27;</span>, <span class="string">&#x27;pizza&#x27;</span>, <span class="string">&#x27;donut&#x27;</span>, <span class="string">&#x27;cake&#x27;</span>, <span class="string">&#x27;chair&#x27;</span>, <span class="string">&#x27;couch&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;potted_plant&#x27;</span>, <span class="string">&#x27;bed&#x27;</span>, <span class="string">&#x27;dining_table&#x27;</span>, <span class="string">&#x27;toilet&#x27;</span>, <span class="string">&#x27;tv&#x27;</span>, <span class="string">&#x27;laptop&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;mouse&#x27;</span>, <span class="string">&#x27;remote&#x27;</span>, <span class="string">&#x27;keyboard&#x27;</span>, <span class="string">&#x27;cell_phone&#x27;</span>, <span class="string">&#x27;microwave&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;oven&#x27;</span>, <span class="string">&#x27;toaster&#x27;</span>, <span class="string">&#x27;sink&#x27;</span>, <span class="string">&#x27;refrigerator&#x27;</span>, <span class="string">&#x27;book&#x27;</span>, <span class="string">&#x27;clock&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;vase&#x27;</span>, <span class="string">&#x27;scissors&#x27;</span>, <span class="string">&#x27;teddy_bear&#x27;</span>, <span class="string">&#x27;hair_drier&#x27;</span>, <span class="string">&#x27;toothbrush&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_annotations</span>(<span class="params">self, ann_file</span>):</span><br><span class="line">        self.coco = COCO(ann_file)</span><br><span class="line">        self.cat_ids = self.coco.getCatIds()</span><br><span class="line">        self.cat2label = &#123;</span><br><span class="line">            cat_id: i + <span class="number">1</span></span><br><span class="line">            <span class="keyword">for</span> i, cat_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.cat_ids)</span><br><span class="line">        &#125;</span><br><span class="line">        self.img_ids = self.coco.getImgIds()</span><br><span class="line">        img_infos = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.img_ids:</span><br><span class="line">            info = self.coco.loadImgs([i])[<span class="number">0</span>]</span><br><span class="line">            info[<span class="string">&#x27;filename&#x27;</span>] = info[<span class="string">&#x27;file_name&#x27;</span>]</span><br><span class="line">            img_infos.append(info)</span><br><span class="line">        <span class="keyword">return</span> img_infos</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ann_info</span>(<span class="params">self, idx</span>):</span><br><span class="line">        img_id = self.img_infos[idx][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        ann_ids = self.coco.getAnnIds(imgIds=[img_id])</span><br><span class="line">        ann_info = self.coco.loadAnns(ann_ids)</span><br><span class="line">        <span class="keyword">return</span> self._parse_ann_info(ann_info, self.with_mask)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_filter_imgs</span>(<span class="params">self, min_size=<span class="number">32</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Filter images too small or without ground truths.&quot;&quot;&quot;</span></span><br><span class="line">        valid_inds = []</span><br><span class="line">        ids_with_ann = <span class="built_in">set</span>(_[<span class="string">&#x27;image_id&#x27;</span>] <span class="keyword">for</span> _ <span class="keyword">in</span> self.coco.anns.values())</span><br><span class="line">        <span class="keyword">for</span> i, img_info <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.img_infos):</span><br><span class="line">            <span class="keyword">if</span> self.img_ids[i] <span class="keyword">not</span> <span class="keyword">in</span> ids_with_ann:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">min</span>(img_info[<span class="string">&#x27;width&#x27;</span>], img_info[<span class="string">&#x27;height&#x27;</span>]) &gt;= min_size:</span><br><span class="line">                valid_inds.append(i)</span><br><span class="line">        <span class="keyword">return</span> valid_inds</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_ann_info</span>(<span class="params">self, ann_info, with_mask=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Parse bbox and mask annotation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            ann_info (list[dict]): Annotation info of an image.</span></span><br><span class="line"><span class="string">            with_mask (bool): Whether to parse mask annotations.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            dict: A dict containing the following keys: bboxes, bboxes_ignore,</span></span><br><span class="line"><span class="string">                labels, masks, mask_polys, poly_lens.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        gt_bboxes = []</span><br><span class="line">        gt_labels = []</span><br><span class="line">        gt_bboxes_ignore = []</span><br><span class="line">        <span class="comment"># Two formats are provided.</span></span><br><span class="line">        <span class="comment"># 1. mask: a binary map of the same size of the image.</span></span><br><span class="line">        <span class="comment"># 2. polys: each mask consists of one or several polys, each poly is a</span></span><br><span class="line">        <span class="comment"># list of float.</span></span><br><span class="line">        <span class="keyword">if</span> with_mask:</span><br><span class="line">            gt_masks = []</span><br><span class="line">            gt_mask_polys = []</span><br><span class="line">            gt_poly_lens = []</span><br><span class="line">        <span class="keyword">for</span> i, ann <span class="keyword">in</span> <span class="built_in">enumerate</span>(ann_info):</span><br><span class="line">            <span class="keyword">if</span> ann.get(<span class="string">&#x27;ignore&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            x1, y1, w, h = ann[<span class="string">&#x27;bbox&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> ann[<span class="string">&#x27;area&#x27;</span>] &lt;= <span class="number">0</span> <span class="keyword">or</span> w &lt; <span class="number">1</span> <span class="keyword">or</span> h &lt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            bbox = [x1, y1, x1 + w - <span class="number">1</span>, y1 + h - <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> ann[<span class="string">&#x27;iscrowd&#x27;</span>]:</span><br><span class="line">                gt_bboxes_ignore.append(bbox)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                gt_bboxes.append(bbox)</span><br><span class="line">                gt_labels.append(self.cat2label[ann[<span class="string">&#x27;category_id&#x27;</span>]])</span><br><span class="line">            <span class="keyword">if</span> with_mask:</span><br><span class="line">                gt_masks.append(self.coco.annToMask(ann))</span><br><span class="line">                mask_polys = [</span><br><span class="line">                    p <span class="keyword">for</span> p <span class="keyword">in</span> ann[<span class="string">&#x27;segmentation&#x27;</span>] <span class="keyword">if</span> <span class="built_in">len</span>(p) &gt;= <span class="number">6</span></span><br><span class="line">                ]  <span class="comment"># valid polygons have &gt;= 3 points (6 coordinates)</span></span><br><span class="line">                poly_lens = [<span class="built_in">len</span>(p) <span class="keyword">for</span> p <span class="keyword">in</span> mask_polys]</span><br><span class="line">                gt_mask_polys.append(mask_polys)</span><br><span class="line">                gt_poly_lens.extend(poly_lens)</span><br><span class="line">        <span class="keyword">if</span> gt_bboxes:</span><br><span class="line">            gt_bboxes = np.array(gt_bboxes, dtype=np.float32)</span><br><span class="line">            gt_labels = np.array(gt_labels, dtype=np.int64)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt_bboxes = np.zeros((<span class="number">0</span>, <span class="number">4</span>), dtype=np.float32)</span><br><span class="line">            gt_labels = np.array([], dtype=np.int64)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> gt_bboxes_ignore:</span><br><span class="line">            gt_bboxes_ignore = np.array(gt_bboxes_ignore, dtype=np.float32)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt_bboxes_ignore = np.zeros((<span class="number">0</span>, <span class="number">4</span>), dtype=np.float32)</span><br><span class="line"></span><br><span class="line">        ann = <span class="built_in">dict</span>(</span><br><span class="line">            bboxes=gt_bboxes, labels=gt_labels, bboxes_ignore=gt_bboxes_ignore)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> with_mask:</span><br><span class="line">            ann[<span class="string">&#x27;masks&#x27;</span>] = gt_masks</span><br><span class="line">            <span class="comment"># poly format is not used in the current implementation</span></span><br><span class="line">            ann[<span class="string">&#x27;mask_polys&#x27;</span>] = gt_mask_polys</span><br><span class="line">            ann[<span class="string">&#x27;poly_lens&#x27;</span>] = gt_poly_lens</span><br><span class="line">        <span class="keyword">return</span> ann</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="原理解析-4">4.1.2 原理解析</h4>
<blockquote>
<p>以下内容摘选自：<a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection/blob/master/README.md">mmdetection
/ <strong>README.md</strong></a></p>
<p><strong>Train on custom datasets</strong></p>
<p>We define a simple annotation format.</p>
<p>The annotation of a dataset is a list of dict, each dict corresponds
to an image. There are 3 field <code>filename</code> (relative path),
<code>width</code>, <code>height</code> for testing, and an additional
field <code>ann</code> for training. <code>ann</code> is also a dict
containing at least 2 fields: <code>bboxes</code> and
<code>labels</code>, both of which are numpy arrays. Some datasets may
provide annotations like crowd/difficult/ignored bboxes, we use
<code>bboxes_ignore</code> and <code>labels_ignore</code> to cover
them.</p>
<p>Here is an example.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line">  &#x27;filename&#x27;: &#x27;a.jpg&#x27;,</span><br><span class="line">  &#x27;width&#x27;: 1280,</span><br><span class="line">  &#x27;height&#x27;: 720,</span><br><span class="line">  &#x27;ann&#x27;: &#123;</span><br><span class="line">      &#x27;bboxes&#x27;: &lt;np.ndarray&gt; (n, 4),</span><br><span class="line">      &#x27;labels&#x27;: &lt;np.ndarray&gt; (n, ),</span><br><span class="line">      &#x27;bboxes_ignore&#x27;: &lt;np.ndarray&gt; (k, 4),</span><br><span class="line">      &#x27;labels_ignore&#x27;: &lt;np.ndarray&gt; (k, ) (optional field)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>There are two ways to work with custom datasets.</p>
<ul>
<li><strong>online conversion</strong></li>
</ul>
<p><strong>You can write a new Dataset class inherited from
<code>CustomDataset</code>, and overwrite two methods
<code>load_annotations(self, ann_file)</code> and
<code>get_ann_info(self, idx)</code>, like <a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/coco.py">CocoDataset</a>
and <a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/voc.py">VOCDataset</a>.</strong></p>
<ul>
<li>offline conversion</li>
</ul>
<p>You can convert the annotation format to the expected format above
and save it to a pickle or json file, like <a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection/blob/master/tools/convert_datasets/pascal_voc.py">pascal_voc.py</a>.
Then you can simply use <code>CustomDataset</code>.</p>
</blockquote>
<p>正如<a
target="_blank" rel="noopener" href="https://github.com/open-mmlab/mmdetection/blob/master/README.md">mmdetection
/
<strong>README.md</strong></a>中所述，<code>coco.py</code>定义的<code>CocoDataset</code>，属于online
conversion，通过继承<code>CustomDataset</code>基础类并重载实现
<code>load_annotations(self, ann_file)</code>
和<code>get_ann_info(self, idx)</code>两个成员函数实现一个自定义的数据集类型加入mmdetection框架，这两个函数是对外调用的接口。</p>
<p><code>load_annotations(self, ann_file)</code>
用于加载标注文件到内存中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_annotations</span>(<span class="params">self, ann_file</span>):</span><br><span class="line">    self.coco = COCO(ann_file)</span><br><span class="line">    self.cat_ids = self.coco.getCatIds()</span><br><span class="line">    self.cat2label = &#123;</span><br><span class="line">        cat_id: i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i, cat_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.cat_ids)</span><br><span class="line">    &#125;</span><br><span class="line">    self.img_ids = self.coco.getImgIds()</span><br><span class="line">    img_infos = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> self.img_ids:</span><br><span class="line">        info = self.coco.loadImgs([i])[<span class="number">0</span>]</span><br><span class="line">        info[<span class="string">&#x27;filename&#x27;</span>] = info[<span class="string">&#x27;file_name&#x27;</span>]</span><br><span class="line">        img_infos.append(info)</span><br><span class="line">        <span class="keyword">return</span> img_infos</span><br></pre></td></tr></table></figure>
<p><code>get_ann_info(self, idx)</code>用于提取指定<code>image idx</code>的某个image的标注信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_ann_info</span>(<span class="params">self, idx</span>):</span><br><span class="line">    img_id = self.img_infos[idx][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">    ann_ids = self.coco.getAnnIds(imgIds=[img_id])</span><br><span class="line">    ann_info = self.coco.loadAnns(ann_ids)</span><br><span class="line">    <span class="keyword">return</span> self._parse_ann_info(ann_info, self.with_mask)</span><br></pre></td></tr></table></figure>
<h2 id="bbox数据结构解析">5 <code>bbox</code>数据结构解析</h2>
<p>作为目标检测系统，候选框是目标检测模型的基本输出。bbox数据结构是处理模型输出结果所必须的掌握的数据结构。</p>
<h3 id="coco数据集的bbox数据结构">5.1 COCO数据集的bbox数据结构</h3>
<p>COCO数据集的标注中，目标检测标注内容的JSON数据结构如下：</p>
<blockquote>
<p>以下内容摘选自：<a target="_blank" rel="noopener" href="http://cocodataset.org/#format-data">COCO
DataFormat</a></p>
<p><strong>1. Object Detection</strong></p>
<p>Each object instance annotation contains a series of fields,
including the category id and segmentation mask of the object. The
segmentation format depends on whether the instance represents a single
object (iscrowd=0 in which case polygons are used) or a collection of
objects (iscrowd=1 in which case RLE is used). Note that a single object
(iscrowd=0) may require multiple polygons, for example if occluded.
Crowd annotations (iscrowd=1) are used to label large groups of objects
(e.g. a crowd of people). <strong>In addition, an enclosing bounding box
is provided for each object (box coordinates are measured from the top
left image corner and are 0-indexed).</strong></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">annotation<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> int<span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;image_id&quot;</span> <span class="punctuation">:</span> int<span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;category_id&quot;</span> <span class="punctuation">:</span> int<span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;segmentation&quot;</span> <span class="punctuation">:</span> RLE or <span class="punctuation">[</span>polygon<span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;area&quot;</span> <span class="punctuation">:</span> float<span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;bbox&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span>x<span class="punctuation">,</span>y<span class="punctuation">,</span>width<span class="punctuation">,</span>height<span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;iscrowd&quot;</span> <span class="punctuation">:</span> <span class="number">0</span> or <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>详细文档可参阅：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://cocodataset.org/#format-data">COCO DataFormat</a></p>
</blockquote>
<p>在COCO数据集遵循的标注规范中，边界框（<strong><em>bbox</em></strong>,
<em>bounding box</em>）的数据结构是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;bbox&quot; : [x,y,width,height], </span><br></pre></td></tr></table></figure>
<p>目标物体通过边界框来标注，边界框则通过其左上角坐标<em>(x,
y)</em>以及边界框的宽度<em>width</em>和高度<em>height</em>来确定。单位均为像素。</p>
<h3 id="mmdetection中的bbox数据结构">5.2
mmdetection中的bbox数据结构</h3>
<h4 id="cocodataset对bbox的解析转换">5.2.1
<code>CocoDataset</code>对bbox的解析转换</h4>
<p><code>CocoDataset</code>定义于4.1节中提到的<code>coco.py</code>。</p>
<p><code>CocoDataset</code>负责将外部的COCO数据集读取解析并转换为mmdetection框架实际处理使用的数据结构。</p>
<p>类内部成员函数<code>_parse_ann_info(ann_info, with_mask)</code>封装了解析单个图片标注信息的流程，<code>get_ann_info(self, idx)</code>在函数堆栈返回时通过调用该解析函数实现对当前图片标注信息的解析。在<code>_parse_ann_info(ann_info, with_mask)</code>函数中，对COCO数据集的<code>"bbox" : [x,y,width,height]</code>候选框数据格式进行了解析和数据结构的转换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, ann <span class="keyword">in</span> <span class="built_in">enumerate</span>(ann_info):</span><br><span class="line">    <span class="keyword">if</span> ann.get(<span class="string">&#x27;ignore&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    x1, y1, w, h = ann[<span class="string">&#x27;bbox&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> ann[<span class="string">&#x27;area&#x27;</span>] &lt;= <span class="number">0</span> <span class="keyword">or</span> w &lt; <span class="number">1</span> <span class="keyword">or</span> h &lt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    bbox = [x1, y1, x1 + w - <span class="number">1</span>, y1 + h - <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>在<code>_parse_ann_info(ann_info, with_mask)</code>的这段实现中，通过循环遍历标注信息容器<code>ann_info</code>，将COCO数据集中的左上角坐标<code>(x1, y1)</code>、宽<code>w</code>、高<code>h</code>读出。并转换为左上角坐标<code>(x1,y1)</code>和右下角坐标<code>(x1+w-1, y1+h-1)</code>，将这四个坐标值依次写入<code>bbox</code>结构供mmdetection框架处理。</p>
<p>也就是说，mmdetection中的bbox数据结构是通过候选框的<strong>左上角坐标</strong>和<strong>右下角坐标</strong>来标记候选框的。</p>
<h4 id="bbox2result解析">5.2.2 <code>bbox2result</code>解析</h4>
<p>在mmdetection中模型对bbox的实际调用方面，两个基本的目标检测通用模型<code>SingleStageDetector</code>和<code>TwoStageDetector</code>在测试输出时都是通过调用<code>bbox2result</code>函数来将模型输出的结果转换到一个list型的result作为模型最终的返回结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_test</span>(<span class="params">self, img, img_meta, rescale=<span class="literal">False</span></span>):</span><br><span class="line">    x = self.extract_feat(img)</span><br><span class="line">    outs = self.bbox_head(x)</span><br><span class="line">    bbox_inputs = outs + (img_meta, self.test_cfg, rescale)</span><br><span class="line">    bbox_list = self.bbox_head.get_bboxes(*bbox_inputs)</span><br><span class="line">    bbox_results = [</span><br><span class="line">        bbox2result(det_bboxes, det_labels, self.bbox_head.num_classes)</span><br><span class="line">        <span class="keyword">for</span> det_bboxes, det_labels <span class="keyword">in</span> bbox_list</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> bbox_results[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>以<code>SingleStageDetector</code>为例，返回值是通过调用<code>bbox2result</code>取得的。</p>
<h5 id="源代码参考-5">5.2.2.1 源代码参考</h5>
<p><code>bbox2result</code>函数在<code>mmdet\core\bbox\transforms.py</code>中实现，源代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">bbox2result</span>(<span class="params">bboxes, labels, num_classes</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Convert detection results to a list of numpy arrays.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        bboxes (Tensor): shape (n, 5)</span></span><br><span class="line"><span class="string">        labels (Tensor): shape (n, )</span></span><br><span class="line"><span class="string">        num_classes (int): class number, including background class</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list(ndarray): bbox results of each class</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> bboxes.shape[<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            np.zeros((<span class="number">0</span>, <span class="number">5</span>), dtype=np.float32) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_classes - <span class="number">1</span>)</span><br><span class="line">        ]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bboxes = bboxes.cpu().numpy()</span><br><span class="line">        labels = labels.cpu().numpy()</span><br><span class="line">        <span class="keyword">return</span> [bboxes[labels == i, :] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_classes - <span class="number">1</span>)]</span><br></pre></td></tr></table></figure>
<h5 id="原理解析-5">5.2.2.2 原理解析</h5>
<p>根据函数实现内的块注释，可以知道，传入参数bboxes和labels都是PyTorch中的张量类型数据。</p>
<p>在注释中，可以看到<code>bboxes (Tensor): shape (n, 5)</code>表示bboxes是n×5维的矩阵，而<code>labels (Tensor): shape (n, )</code>表示labels包含n条记录。当然，n是对当前图片目标检测后，输出的候选框个数。</p>
<p><strong>一个bbox应该包含4个坐标值来框选目标区域，那么第5个数值是什么呢？</strong></p>
<h4 id="anchorhead.get_boxes解析">5.2.3
<code>AnchorHead.get_boxes</code>解析</h4>
<p>可以看到，在<code>simple_test</code>函数中，是通过调用<code>bbox_head.get_boxes</code>函数取得的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bbox_list = self.bbox_head.get_bboxes(*bbox_inputs)</span><br></pre></td></tr></table></figure>
<h5 id="get_boxes解析">5.2.3.1 <code>get_boxes</code>解析</h5>
<p><code>get_boxes</code>函数在<code>mmdet\models\anchor_heads\anchor_head.py</code>中定义，是<code>AnchorHead</code>的类成员函数。源代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_bboxes</span>(<span class="params">self, cls_scores, bbox_preds, img_metas, cfg,</span></span><br><span class="line"><span class="params">                rescale=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(cls_scores) == <span class="built_in">len</span>(bbox_preds)</span><br><span class="line">    num_levels = <span class="built_in">len</span>(cls_scores)</span><br><span class="line"></span><br><span class="line">    mlvl_anchors = [</span><br><span class="line">        self.anchor_generators[i].grid_anchors(cls_scores[i].size()[-<span class="number">2</span>:],</span><br><span class="line">                                                self.anchor_strides[i])</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_levels)</span><br><span class="line">    ]</span><br><span class="line">    result_list = []</span><br><span class="line">    <span class="keyword">for</span> img_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(img_metas)):</span><br><span class="line">        cls_score_list = [</span><br><span class="line">            cls_scores[i][img_id].detach() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_levels)</span><br><span class="line">        ]</span><br><span class="line">        bbox_pred_list = [</span><br><span class="line">            bbox_preds[i][img_id].detach() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_levels)</span><br><span class="line">        ]</span><br><span class="line">        img_shape = img_metas[img_id][<span class="string">&#x27;img_shape&#x27;</span>]</span><br><span class="line">        scale_factor = img_metas[img_id][<span class="string">&#x27;scale_factor&#x27;</span>]</span><br><span class="line">        proposals = self.get_bboxes_single(cls_score_list, bbox_pred_list,</span><br><span class="line">                                            mlvl_anchors, img_shape,</span><br><span class="line">                                            scale_factor, cfg, rescale)</span><br><span class="line">        result_list.append(proposals)</span><br><span class="line">    <span class="keyword">return</span> result_list</span><br></pre></td></tr></table></figure>
<p><code>get_boxes</code>函数支持对输入的一批图片批量提取区域<em>proposals</em>，并输出分值<em>score</em>和边界框<em>bbox</em>。</p>
<p>在<code>get_boxes</code>函数中，通过for循环遍历img_id并每次调用同为类成员函数的<code>get_boxes_single</code>来对当前img_id提取区域<em>proposals</em>，并将<em>proposals</em>加入容器<em>result_list</em>以便最后遍历完成后返回结果。</p>
<h5 id="get_boxes_single解析">5.2.3.2
<code>get_boxes_single</code>解析</h5>
<p><code>get_boxes</code>函数也在<code>mmdet\models\anchor_heads\anchor_head.py</code>中定义，同为<code>AnchorHead</code>的类成员函数。源代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_bboxes_single</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                        cls_scores,</span></span><br><span class="line"><span class="params">                        bbox_preds,</span></span><br><span class="line"><span class="params">                        mlvl_anchors,</span></span><br><span class="line"><span class="params">                        img_shape,</span></span><br><span class="line"><span class="params">                        scale_factor,</span></span><br><span class="line"><span class="params">                        cfg,</span></span><br><span class="line"><span class="params">                        rescale=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(cls_scores) == <span class="built_in">len</span>(bbox_preds) == <span class="built_in">len</span>(mlvl_anchors)</span><br><span class="line">    mlvl_bboxes = []</span><br><span class="line">    mlvl_scores = []</span><br><span class="line">    <span class="keyword">for</span> cls_score, bbox_pred, anchors <span class="keyword">in</span> <span class="built_in">zip</span>(cls_scores, bbox_preds,</span><br><span class="line">                                                mlvl_anchors):</span><br><span class="line">        <span class="keyword">assert</span> cls_score.size()[-<span class="number">2</span>:] == bbox_pred.size()[-<span class="number">2</span>:]</span><br><span class="line">        cls_score = cls_score.permute(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>).reshape(</span><br><span class="line">            -<span class="number">1</span>, self.cls_out_channels)</span><br><span class="line">        <span class="keyword">if</span> self.use_sigmoid_cls:</span><br><span class="line">            scores = cls_score.sigmoid()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            scores = cls_score.softmax(-<span class="number">1</span>)</span><br><span class="line">        bbox_pred = bbox_pred.permute(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>).reshape(-<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">        nms_pre = cfg.get(<span class="string">&#x27;nms_pre&#x27;</span>, -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> nms_pre &gt; <span class="number">0</span> <span class="keyword">and</span> scores.shape[<span class="number">0</span>] &gt; nms_pre:</span><br><span class="line">            <span class="keyword">if</span> self.use_sigmoid_cls:</span><br><span class="line">                max_scores, _ = scores.<span class="built_in">max</span>(dim=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                max_scores, _ = scores[:, <span class="number">1</span>:].<span class="built_in">max</span>(dim=<span class="number">1</span>)</span><br><span class="line">            _, topk_inds = max_scores.topk(nms_pre)</span><br><span class="line">            anchors = anchors[topk_inds, :]</span><br><span class="line">            bbox_pred = bbox_pred[topk_inds, :]</span><br><span class="line">            scores = scores[topk_inds, :]</span><br><span class="line">        bboxes = delta2bbox(anchors, bbox_pred, self.target_means,</span><br><span class="line">                            self.target_stds, img_shape)</span><br><span class="line">        mlvl_bboxes.append(bboxes)</span><br><span class="line">        mlvl_scores.append(scores)</span><br><span class="line">    mlvl_bboxes = torch.cat(mlvl_bboxes)</span><br><span class="line">    <span class="keyword">if</span> rescale:</span><br><span class="line">        mlvl_bboxes /= mlvl_bboxes.new_tensor(scale_factor)</span><br><span class="line">    mlvl_scores = torch.cat(mlvl_scores)</span><br><span class="line">    <span class="keyword">if</span> self.use_sigmoid_cls:</span><br><span class="line">        padding = mlvl_scores.new_zeros(mlvl_scores.shape[<span class="number">0</span>], <span class="number">1</span>)</span><br><span class="line">        mlvl_scores = torch.cat([padding, mlvl_scores], dim=<span class="number">1</span>)</span><br><span class="line">    det_bboxes, det_labels = multiclass_nms(</span><br><span class="line">        mlvl_bboxes, mlvl_scores, cfg.score_thr, cfg.nms, cfg.max_per_img)</span><br><span class="line">    <span class="keyword">return</span> det_bboxes, det_labels</span><br></pre></td></tr></table></figure>
<p>在这份代码中，返回输出的是<code>det_bboxes</code>以及<code>det_labels</code>，分别对应调用<code>bbox2result</code>时的输入参数<code>bboxes</code>和<code>labels</code>。</p>
<p>而<code>get_boxes_single</code>函数的返回值又是通过调用<code>multiclass_nms</code>函数取得的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">det_bboxes, det_labels = multiclass_nms(</span><br><span class="line">    mlvl_bboxes, mlvl_scores, cfg.score_thr, cfg.nms, cfg.max_per_img)</span><br><span class="line"><span class="keyword">return</span> det_bboxes, det_labels</span><br></pre></td></tr></table></figure>
<h4 id="multiclass_nms解析">5.2.4 <code>multiclass_nms</code>解析</h4>
<h5 id="源代码参考-6">5.2.4.1 源代码参考</h5>
<p><code>multiclass_nms</code>函数在<code>mmdet\core\post_processing\bbox_nms.py</code>中定义。该文件中只包含这一个函数的定义实现，源代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mmdet.ops.nms <span class="keyword">import</span> nms_wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multiclass_nms</span>(<span class="params">multi_bboxes, multi_scores, score_thr, nms_cfg, max_num=-<span class="number">1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;NMS for multi-class bboxes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        multi_bboxes (Tensor): shape (n, #class*4) or (n, 4)</span></span><br><span class="line"><span class="string">        multi_scores (Tensor): shape (n, #class)</span></span><br><span class="line"><span class="string">        score_thr (float): bbox threshold, bboxes with scores lower than it</span></span><br><span class="line"><span class="string">            will not be considered.</span></span><br><span class="line"><span class="string">        nms_thr (float): NMS IoU threshold</span></span><br><span class="line"><span class="string">        max_num (int): if there are more than max_num bboxes after NMS,</span></span><br><span class="line"><span class="string">            only top max_num will be kept.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        tuple: (bboxes, labels), tensors of shape (k, 5) and (k, 1). Labels</span></span><br><span class="line"><span class="string">            are 0-based.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    num_classes = multi_scores.shape[<span class="number">1</span>]</span><br><span class="line">    bboxes, labels = [], []</span><br><span class="line">    nms_cfg_ = nms_cfg.copy()</span><br><span class="line">    nms_type = nms_cfg_.pop(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;nms&#x27;</span>)</span><br><span class="line">    nms_op = <span class="built_in">getattr</span>(nms_wrapper, nms_type)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, num_classes):</span><br><span class="line">        cls_inds = multi_scores[:, i] &gt; score_thr</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cls_inds.<span class="built_in">any</span>():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># get bboxes and scores of this class</span></span><br><span class="line">        <span class="keyword">if</span> multi_bboxes.shape[<span class="number">1</span>] == <span class="number">4</span>:</span><br><span class="line">            _bboxes = multi_bboxes[cls_inds, :]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            _bboxes = multi_bboxes[cls_inds, i * <span class="number">4</span>:(i + <span class="number">1</span>) * <span class="number">4</span>]</span><br><span class="line">        _scores = multi_scores[cls_inds, i]</span><br><span class="line">        cls_dets = torch.cat([_bboxes, _scores[:, <span class="literal">None</span>]], dim=<span class="number">1</span>)</span><br><span class="line">        cls_dets, _ = nms_op(cls_dets, **nms_cfg_)</span><br><span class="line">        cls_labels = multi_bboxes.new_full(</span><br><span class="line">            (cls_dets.shape[<span class="number">0</span>], ), i - <span class="number">1</span>, dtype=torch.long)</span><br><span class="line">        bboxes.append(cls_dets)</span><br><span class="line">        labels.append(cls_labels)</span><br><span class="line">    <span class="keyword">if</span> bboxes:</span><br><span class="line">        bboxes = torch.cat(bboxes)</span><br><span class="line">        labels = torch.cat(labels)</span><br><span class="line">        <span class="keyword">if</span> bboxes.shape[<span class="number">0</span>] &gt; max_num:</span><br><span class="line">            _, inds = bboxes[:, -<span class="number">1</span>].sort(descending=<span class="literal">True</span>)</span><br><span class="line">            inds = inds[:max_num]</span><br><span class="line">            bboxes = bboxes[inds]</span><br><span class="line">            labels = labels[inds]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bboxes = multi_bboxes.new_zeros((<span class="number">0</span>, <span class="number">5</span>))</span><br><span class="line">        labels = multi_bboxes.new_zeros((<span class="number">0</span>, ), dtype=torch.long)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bboxes, labels</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="原理解析-6">5.2.4.2 原理解析</h5>
<p>由函数的块注释可以得知，这是一段实现候选框NMS功能的代码。NMS就是<strong>非极大值抑制（Non-Maximum
Suppression，NMS）</strong>，指的就是对重叠候选框，抑制非极大的候选框，而选出分数<em>score</em>为极大值的候选框。</p>
<blockquote>
<p><strong>非极大值抑制（Non-Maximum
Suppression，NMS）</strong>，顾名思义就是抑制不是极大值的元素，可以理解为局部最大搜索。这个局部代表的是一个邻域，邻域有两个参数可变，一是邻域的维数，二是邻域的大小。这里不讨论通用的NMS算法(参考论文《<a
target="_blank" rel="noopener" href="https://pdfs.semanticscholar.org/52ca/4ed04d1d9dba3e6ae30717898276735e0b79.pdf">Efficient
Non-Maximum
Suppression</a>》对1维和2维数据的NMS实现)，而是用于目标检测中提取分数最高的窗口的。例如在行人检测中，滑动窗口经提取特征，经分类器分类识别后，每个窗口都会得到一个分数。但是滑动窗口会导致很多窗口与其他窗口存在包含或者大部分交叉的情况。这时就需要用到NMS来选取那些邻域里分数最高（是行人的概率最大），并且抑制那些分数低的窗口。
NMS在计算机视觉领域有着非常重要的应用，如视频目标跟踪、数据挖掘、3D重建、目标识别以及纹理分析等。</p>
<hr />
<p><em>著作权归作者所有。商业转载请联系作者获得授权,非商业转载请注明出处。</em>
<em>原文: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/makefile/p/nms.html"
class="uri">https://www.cnblogs.com/makefile/p/nms.html</a> © <a
target="_blank" rel="noopener" href="http://www.cnblogs.com/makefile">康行天下</a></em></p>
</blockquote>
<p>结合函数的注释，可以知道在该函数的输入中，主要的四个输入参数为：</p>
<ul>
<li><code>multi_bboxes</code>：输入的n×4维矩阵。n个候选框，每个候选框4个坐标值。
<ul>
<li>对多类（multiclass），可以是n×#class*4维，即在该目标位置，对每类预测不同的候选框形状。</li>
</ul></li>
<li><code>multi_scores</code>：输入的n维向量。n个<em>score</em>分值，n个候选框对应的分值。</li>
<li><code>score_thr</code>：候选框的分值阈值，低于该阈值的候选框须滤除。</li>
<li><code>nms_cfg</code>：NMS的交并比IoU阈值，达到该阈值的才作为NMS局部最大搜索的邻域。</li>
</ul>
<p>在函数实现中，通过for循环遍历各个类，对每个类，判断哪些行（候选框）的第i类的score高于score阈值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cls_inds = multi_scores[:, i] &gt; score_thr</span><br></pre></td></tr></table></figure>
<p>此处的<code>cls_inds</code>为n维的Bool型向量。</p>
<p>接下来，通过<code>cls_inds</code>Bool向量将当前第i类（亦第i列）的，高于阈值（cls_inds[row_id]）为True的行筛选出来，取得这些<em>score</em>高于阈值的<em>bboxes</em>和<em>scores</em>，存放在<code>_bboxes</code>和<code>_scores</code>中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get bboxes and scores of this class</span></span><br><span class="line"><span class="keyword">if</span> multi_bboxes.shape[<span class="number">1</span>] == <span class="number">4</span>:</span><br><span class="line">    _bboxes = multi_bboxes[cls_inds, :]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    _bboxes = multi_bboxes[cls_inds, i * <span class="number">4</span>:(i + <span class="number">1</span>) * <span class="number">4</span>]</span><br><span class="line">_scores = multi_scores[cls_inds, i]</span><br></pre></td></tr></table></figure>
<p>随后，将<code>_bboxes</code>和<code>_scores</code>做结构转换以便维度和谐，并进行拼接，输出该类的检测结果<code>cls_dets</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cls_dets = torch.cat([_bboxes, _scores[:, <span class="literal">None</span>]], dim=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>然后，调用<code>nms_op</code>函数对<code>cls_dets</code>做NMS操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cls_dets, _ = nms_op(cls_dets, **nms_cfg_)</span><br></pre></td></tr></table></figure>
<p><code>cls_dets</code>此后被加入<code>bboxes</code>中，作为最终函数返回的数据结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bboxes.append(cls_dets)</span><br></pre></td></tr></table></figure>
<p>到这里，可以真正理解：<strong><code>bboxes</code>中的数据结构实际上是候选框的坐标信息（<code>_bboxes</code>，即每个bbox的左上角坐标x1,
y1和右下角坐标x1+w-1,
y2+h-1，共4维）和候选框对应的分值（<code>_scores</code>，即每个bbox的score，共1维）。</strong>因此每一个bbox在mmdetection的模型的预测输出中是一个5维张量。</p>
<p>本节所述的<code>multiclass_nms</code>函数通过返回值，将该数据结构的<code>bboxes</code>返回给以上所述的<code>get_boxes_single</code>，继而返回给<code>get_boxes</code>，再返回给<code>bbox2result</code>，最终成为模型测试<code>simple_test</code>函数输出的结果<code>bbox_results</code>。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Heary 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Heary 支付宝">
        <span>支付宝</span>
      </div>
      <div>
        <img src="/images/paypal.png" alt="Heary PayPal">
        <span>PayPal</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Heary
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://heary.cn/posts/mmdetection-%E5%9F%BA%E4%BA%8EPyTorch%E7%9A%84%E5%BC%80%E6%BA%90%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/" title="mmdetection - 基于PyTorch的开源目标检测系统">https://heary.cn/posts/mmdetection-基于PyTorch的开源目标检测系统/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Object-Detection/" rel="tag"><i class="fa fa-tag"></i> Object Detection</a>
              <a href="/tags/CV/" rel="tag"><i class="fa fa-tag"></i> CV</a>
              <a href="/tags/PyTorch/" rel="tag"><i class="fa fa-tag"></i> PyTorch</a>
              <a href="/tags/mmdetection/" rel="tag"><i class="fa fa-tag"></i> mmdetection</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/PyTorch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="prev" title="PyTorch学习笔记">
                  <i class="fa fa-angle-left"></i> PyTorch学习笔记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/%E5%8D%9A%E5%BC%88%E8%AE%BA%E7%AC%94%E8%AE%B0/" rel="next" title="博弈论笔记">
                  博弈论笔记 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2016 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Heary</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">223k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">13:32</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  

  <a href="https://github.com/HearyShen" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"HearyShen","repo":"gitalk-comments","client_id":"77d476596d65dea261b8","client_secret":"225837e23b2eb099dc77a3aa38dbeefffef4599b","admin_user":"HearyShen","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"78ab82d4926bab696a2fb119c7f81f54"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
